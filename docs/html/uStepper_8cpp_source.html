<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>uStepper: /home/thomas/Dropbox/Arduino/libraries/uStepper/src/uStepper.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">uStepper
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">uStepper.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="uStepper_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/********************************************************************************************</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">*       File:       uStepper.cpp                                                            *</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">*       Version:    0.4.2                                                                   *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">*       date:       August 3rd, 2016                                                        *</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">*       Author:     Thomas HÃ¸rring Olsen                                                    *</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">*                                                                                           *   </span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">*********************************************************************************************</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">*                       uStepper class                                                      *</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">*   This file contains the implementation of the class methods, incorporated in the         *</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">*   uStepper arduino library. The library is used by instantiating an uStepper object       *</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">*   by calling either of the two overloaded constructors:                                   *</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">*       example:                                                                            *</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">*       uStepper stepper;                                                                   *</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">*       OR                                                                                  *</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">*       uStepper stepper(500, 2000);                                                        *</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">*   The first instantiation above creates a uStepper object with default acceleration       *</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">*   and maximum speed (1000 steps/s^2 and 1000steps/s respectively).                        *</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">*   The second instantiation overwrites the default settings of acceleration and            *</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">*   maximum speed (in this case 500 steps/s^2 and 2000 steps/s, respectively);              *</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">*   after instantiation of the object, the object setup function should be called within    *</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">*   arduino&#39;s setup function:                                                               *</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">*       example:                                                                            *</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">*       uStepper stepper;                                                                   *</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">*       void setup()                                                                        *</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">*       {                                                                                   *</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">*           stepper.setup();                                                                *</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">*       }                                                                                   *</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">*       void loop()                                                                         *</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">*       {                                                                                   *</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">*       }                                                                                   *</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">*   After this, the library is ready to control the motor!                                  *</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">*********************************************************************************************</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">*   (C) 2016                                                                                *</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">*   ON Development IVS                                                                      *</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment">*   www.on-development.com                                                                  *</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">*   administration@on-development.com                                                       *</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">*   The code contained in this file is released under the following open source license:    *</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment">*           Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International         *</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment">*   The code in this file is provided without warranty of any kind - use at own risk!       *</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">*   neither ON Development IVS nor the author, can be held responsible for any damage       *</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">*   caused by the use of the code contained in this file !                                  *</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment">*                                                                                           *</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment">********************************************************************************************/</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="uStepper_8h.html">uStepper.h</a>&gt;</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<a class="code" href="classuStepper.html">uStepper</a> *pointer;</div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="uStepper_8h.html#a3216dd3022dcb4a4e82d44fd41509e8e">   73</a></span>&#160;<a class="code" href="classi2cMaster.html">i2cMaster</a> <a class="code" href="uStepper_8cpp.html#a3216dd3022dcb4a4e82d44fd41509e8e">I2C</a>;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="keyword">volatile</span> uint16_t i = 0;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keyword">volatile</span> int32_t stepCnt = 0, control = 0;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keywordtype">void</span> INT1_vect(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    {</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        <span class="keywordflow">if</span>((PIND &amp; (0x20)))         <span class="comment">//CCW</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        {</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            <span class="keywordflow">if</span>(control == 0)</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;            {</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                PORTD |= (1 &lt;&lt; 7);  <span class="comment">//Set dir to CCW</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            }           </div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;            stepCnt--;              <span class="comment">//DIR is set to CCW, therefore we subtract 1 step from step count (negative values = number of steps in CCW direction from initial postion)</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        }</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        <span class="keywordflow">else</span>                        <span class="comment">//CW</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        {</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            <span class="keywordflow">if</span>(control == 0)</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            {</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                </div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                PORTD &amp;= ~(1 &lt;&lt; 7); <span class="comment">//Set dir to CW</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;            }</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            stepCnt++;              <span class="comment">//DIR is set to CW, therefore we add 1 step to step count (positive values = number of steps in CW direction from initial postion)  </span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        }</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        <span class="keywordflow">if</span>(control == 0)            <span class="comment">//If no steps are lost, redirect step pulses        </span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        {</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            PORTD |= (1 &lt;&lt; 4);      <span class="comment">//generate step pulse</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            delayMicroseconds(1);   <span class="comment">//wait a small time</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            PORTD &amp;= ~(1 &lt;&lt; 4);     <span class="comment">//pull step pin low again</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        }</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    }</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="keywordtype">void</span> INT0_vect(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    {</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="keywordflow">if</span>(PIND &amp; 0x04)</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        {</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            PORTB |= (1 &lt;&lt; 0);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        {</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            PORTB &amp;= ~(1 &lt;&lt; 0);</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        }</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    }</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keywordtype">void</span> TIMER2_COMPA_vect(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    {   </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r16 \n\t&quot;</span>);</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;in r16,0x3F \n\t&quot;</span>);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r16 \n\t&quot;</span>);</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r30 \n\t&quot;</span>);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r31 \n\t&quot;</span>);</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;lds r30,pointer \n\t&quot;</span>);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;lds r31,pointer+1 \n\t&quot;</span>);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;ldd r16,z+56 \n\t&quot;</span>);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;sbrs r16,0 \n\t&quot;</span>);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;jmp _AccelerationAlgorithm \n\t&quot;</span>);    <span class="comment">//Execute the acceleration profile algorithm</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        </div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r0 \n\t&quot;</span>);</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r1 \n\t&quot;</span>);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r2 \n\t&quot;</span>);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r3 \n\t&quot;</span>);</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r4 \n\t&quot;</span>);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r5 \n\t&quot;</span>);</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r6 \n\t&quot;</span>);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r7 \n\t&quot;</span>);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r8 \n\t&quot;</span>);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r9 \n\t&quot;</span>);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r10 \n\t&quot;</span>);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r11 \n\t&quot;</span>);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r12 \n\t&quot;</span>);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r13 \n\t&quot;</span>);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r14 \n\t&quot;</span>);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r15 \n\t&quot;</span>);</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r17 \n\t&quot;</span>);</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r18 \n\t&quot;</span>);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r19 \n\t&quot;</span>);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r20 \n\t&quot;</span>);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r21 \n\t&quot;</span>);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r22 \n\t&quot;</span>);</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r23 \n\t&quot;</span>);</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r24 \n\t&quot;</span>);</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r25 \n\t&quot;</span>);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r26 \n\t&quot;</span>);</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r27 \n\t&quot;</span>);</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r28 \n\t&quot;</span>);</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;push r29 \n\t&quot;</span>);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        <span class="keywordflow">if</span>(i &lt; pointer-&gt;faultStepDelay)     <span class="comment">//This value defines the speed at which the motor rotates when compensating for lost steps. This value should be tweaked to the application</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        {</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;            i++;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        {   </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            PORTD |= (1 &lt;&lt; 4);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            delayMicroseconds(1);</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            PORTD &amp;= ~(1 &lt;&lt; 4); </div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;            <span class="keywordflow">if</span>(control &lt; 0)</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            {</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                control += 1;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            }</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(control &gt; 0)</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;            {</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                control -= 1;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;            }</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;            i = 0;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        }</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r29 \n\t&quot;</span>);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r28 \n\t&quot;</span>);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r27 \n\t&quot;</span>);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r26 \n\t&quot;</span>);</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r25 \n\t&quot;</span>);</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r24 \n\t&quot;</span>);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r23 \n\t&quot;</span>);</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r22 \n\t&quot;</span>);</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r21 \n\t&quot;</span>);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r20 \n\t&quot;</span>);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r19 \n\t&quot;</span>);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r18 \n\t&quot;</span>);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r17 \n\t&quot;</span>);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r15 \n\t&quot;</span>);</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r14 \n\t&quot;</span>);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r13 \n\t&quot;</span>);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r12 \n\t&quot;</span>);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r11 \n\t&quot;</span>);</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r10 \n\t&quot;</span>);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r9 \n\t&quot;</span>);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r8 \n\t&quot;</span>);</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r7 \n\t&quot;</span>);</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r6 \n\t&quot;</span>);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r5 \n\t&quot;</span>);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r4 \n\t&quot;</span>);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r3 \n\t&quot;</span>);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r2 \n\t&quot;</span>);</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r1 \n\t&quot;</span>);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r0 \n\t&quot;</span>);</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r31 \n\t&quot;</span>);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r30 \n\t&quot;</span>);</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r16 \n\t&quot;</span>);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;out 0x3F,r16 \n\t&quot;</span>);</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pop r16 \n\t&quot;</span>);</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;reti \n\t&quot;</span>);</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    }</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordtype">void</span> TIMER1_COMPA_vect(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    {</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordtype">float</span> error;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        <span class="keywordtype">float</span> deltaAngle, newSpeed;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="keyword">static</span> <span class="keywordtype">float</span> curAngle, oldAngle = 0.0, deltaSpeedAngle = 0.0, oldSpeed = 0.0;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="keyword">static</span> uint8_t loops = 0;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="keyword">static</span> <span class="keywordtype">float</span> revolutions = 0.0;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        uint8_t data[2];</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        sei();</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keywordflow">if</span>(I2C.<a class="code" href="classi2cMaster.html#a20091cd125f847e2cf50d0c7373adaa0">getStatus</a>() != <a class="code" href="uStepper_8h.html#a46fd28b671402790a8b9c4c2dde700d8">I2CFREE</a>)</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        {</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        }</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        I2C.<a class="code" href="classi2cMaster.html#a9d56b4ea47659456f19cff59ac96d5f9">read</a>(<a class="code" href="uStepper_8h.html#a2e619f47c3bc5b6af8ea904dbf5c98fe">ENCODERADDR</a>, <a class="code" href="uStepper_8h.html#a8a7f485573c16394fc0792a66bd02c7a">ANGLE</a>, 2, data);</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        curAngle = (float)((((uint16_t)data[0]) &lt;&lt; 8 ) | (uint16_t)data[1])*0.087890625;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        pointer-&gt;<a class="code" href="classuStepper.html#a44dea3569998b908a326fbe6509417e9">encoder</a>.angle = curAngle;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        curAngle -= pointer-&gt;<a class="code" href="classuStepper.html#a44dea3569998b908a326fbe6509417e9">encoder</a>.<a class="code" href="classuStepperEncoder.html#a732a1d71de7978312f24a70b8c1301a4">encoderOffset</a>;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        curAngle = fmod(curAngle + 360.0, 360.0);</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        deltaAngle = (oldAngle - curAngle);</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        <span class="comment">//count number of revolutions, on angle overflow</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="keywordflow">if</span>(deltaAngle &lt; -180.0)</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        {</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;            revolutions -= 1.0;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            deltaAngle += 360;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        }</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(deltaAngle &gt; 180.0)</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        {</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            revolutions += 1.0;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            deltaAngle -= 360.0;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        }</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        </div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <span class="keywordflow">if</span>( loops &lt; 10)</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        {</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            loops++;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;            deltaSpeedAngle += deltaAngle;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        }</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        {</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            newSpeed = (deltaSpeedAngle*<a class="code" href="uStepper_8h.html#a1dcbcf84029ec88eb045567b083355c8">ENCODERSPEEDCONSTANT</a>);</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            newSpeed = oldSpeed*ALPHA + newSpeed*BETA;                  <span class="comment">//Filter</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;            oldSpeed = newSpeed;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            pointer-&gt;<a class="code" href="classuStepper.html#a44dea3569998b908a326fbe6509417e9">encoder</a>.<a class="code" href="classuStepperEncoder.html#afe0647659291c6ed4f4104e95f5ae047">curSpeed</a> = newSpeed;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;            loops = 0;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;            deltaSpeedAngle = 0.0;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        }</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        pointer-&gt;<a class="code" href="classuStepper.html#a44dea3569998b908a326fbe6509417e9">encoder</a>.<a class="code" href="classuStepperEncoder.html#a5185708424b99dd13bbe6d9f0ad4f603">angleMoved</a> = curAngle + (360.0*revolutions);</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        oldAngle = curAngle;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        pointer-&gt;<a class="code" href="classuStepper.html#a44dea3569998b908a326fbe6509417e9">encoder</a>.<a class="code" href="classuStepperEncoder.html#a372f52c9553676ebb2ea08f6624f3042">oldAngle</a> = curAngle;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        <span class="keywordflow">if</span>(pointer-&gt;dropIn)</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        {</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            cli();</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                error = (float)stepCnt;  <span class="comment">//atomic read to ensure no fuckups happen from the external interrupt routine</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            sei();</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            error *= pointer-&gt;stepResolution;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            error -= pointer-&gt;<a class="code" href="classuStepper.html#a44dea3569998b908a326fbe6509417e9">encoder</a>.<a class="code" href="classuStepperEncoder.html#a5185708424b99dd13bbe6d9f0ad4f603">angleMoved</a>;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            <span class="keywordflow">if</span>(error &gt; pointer-&gt;tolerance)  </div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;            {</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                PORTB &amp;= ~(1 &lt;&lt; 0);</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                control = (int32_t)(error/pointer-&gt;stepResolution);</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                </div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                PORTD |= (1 &lt;&lt; 7);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                pointer-&gt;<a class="code" href="classuStepper.html#aa3a08ba0871ec3fd1f0deba270d9bacf">startTimer</a>();  </div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            }</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(error &lt; -pointer-&gt;tolerance)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            {</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                PORTB &amp;= ~(1 &lt;&lt; 0);</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                control = (int32_t)(error/pointer-&gt;stepResolution);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                PORTD &amp;= ~(1 &lt;&lt; 7);</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                </div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                pointer-&gt;<a class="code" href="classuStepper.html#aa3a08ba0871ec3fd1f0deba270d9bacf">startTimer</a>();  </div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            }</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            {</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                PORTB |= (PIND &amp; 0x04) &gt;&gt; 2;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                control = 0;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                pointer-&gt;<a class="code" href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4">stopTimer</a>();</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            }</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        }</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    }</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;}</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;float2::float2(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;{</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;}</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="keywordtype">float</span> float2::getFloatValue(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;{</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keyword">union</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    {</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordtype">float</span> f;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        uint32_t i;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    } a;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    a.i = (uint32_t)(this-&gt;value &gt;&gt; 25);</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keywordflow">return</span> a.f;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;}</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;uint64_t float2::getRawValue(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;{</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="keywordflow">return</span> this-&gt;value;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;}</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="keywordtype">void</span> float2::setValue(<span class="keywordtype">float</span> val)</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;{</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <span class="keyword">union</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    {</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        <span class="keywordtype">float</span> f;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        uint32_t i;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    } a;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    a.f = val;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    this-&gt;value = ((uint64_t)a.i) &lt;&lt; 25;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;}</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordtype">bool</span> float2::operator&lt;=(<span class="keyword">const</span> <span class="keywordtype">float</span> &amp;value)</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;{</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordflow">if</span>(this-&gt;getFloatValue() &gt; value)</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    {</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    }</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keywordflow">if</span>(this-&gt;getFloatValue() == value)</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    {</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        <span class="keywordflow">if</span>((this-&gt;value &amp; 0x0000000000007FFF) &gt; 0)</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        {</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        }</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    }</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;}</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="keywordtype">bool</span> float2::operator&lt;=(<span class="keyword">const</span> <a class="code" href="classfloat2.html">float2</a> &amp;value)</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;{</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordflow">if</span>((this-&gt;value &gt;&gt; 56) &gt; (value.value &gt;&gt; 56))               <span class="comment">// sign bit of &quot;this&quot; bigger than sign bit of &quot;value&quot;?</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    {</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="keywordflow">return</span> 1;                                               <span class="comment">//&quot;This&quot; is negative while &quot;value&quot; is not. ==&gt; &quot;this&quot; &lt; &quot;value&quot;</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    }</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordflow">if</span>((this-&gt;value &gt;&gt; 56) == (value.value &gt;&gt; 56))              <span class="comment">//Sign bit of &quot;this&quot; == sign bit of &quot;value&quot;?</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    {</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="keywordflow">if</span>( (this-&gt;value &gt;&gt; 48) &lt; (value.value &gt;&gt; 48) )         <span class="comment">//Exponent of &quot;this&quot; &lt; exponent of &quot;value&quot;?</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        {</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            <span class="keywordflow">return</span> 1;                                           <span class="comment">//==&gt; &quot;this&quot; is smaller than &quot;value&quot;</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        }</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        <span class="keywordflow">if</span>( (this-&gt;value &gt;&gt; 48) == (value.value &gt;&gt; 48) )        <span class="comment">//Exponent of &quot;this&quot; == exponent of &quot;value&quot;?</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        {</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            <span class="keywordflow">if</span>((this-&gt;value &amp; 0x0000FFFFFFFFFFFF) &lt;= (value.value &amp; 0x0000FFFFFFFFFFFF))        <span class="comment">//mantissa of &quot;this&quot; &lt;= mantissa of &quot;value&quot;?</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;            {</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                <span class="keywordflow">return</span> 1;                                       <span class="comment">//==&gt; &quot;this&quot; &lt;= &quot;value&quot;</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            }</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        }</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    }</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="keywordflow">return</span> 0;                                                   <span class="comment">//&quot;this&quot; &gt; &quot;value&quot;</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;}</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<a class="code" href="classfloat2.html">float2</a> &amp; float2::operator=(<span class="keyword">const</span> <span class="keywordtype">float</span> &amp;value)</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;{</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    this-&gt;setValue(value);</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;}</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<a class="code" href="classfloat2.html">float2</a> &amp; float2::operator+=(<span class="keyword">const</span> <span class="keywordtype">float</span> &amp;value)</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;{</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;}</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<a class="code" href="classfloat2.html">float2</a> &amp; float2::operator+=(<span class="keyword">const</span> <a class="code" href="classfloat2.html">float2</a> &amp;value)</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;{</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <a class="code" href="classfloat2.html">float2</a> temp = value;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    uint64_t tempMant, tempExp;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    uint8_t cnt;    <span class="comment">//how many times should we shift the mantissa of the smallest number to add the two mantissa&#39;s</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">if</span>((this-&gt;value &gt;&gt; 56) == (temp.value &gt;&gt; 56))</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    {</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordflow">if</span>(*<span class="keyword">this</span> &lt;= temp)</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;            cnt = (temp.value &gt;&gt; 48) - (this-&gt;value &gt;&gt; 48);</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            <span class="keywordflow">if</span>(cnt &lt; 48)</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            {</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                tempExp = (temp.value &gt;&gt; 48);</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                this-&gt;value &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                this-&gt;value |= 0x0001000000000000;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                this-&gt;value &gt;&gt;= cnt;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                tempMant = (temp.value &amp; 0x0000FFFFFFFFFFFF) | 0x0001000000000000;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                tempMant += this-&gt;value;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                <span class="keywordflow">while</span>(tempMant &gt; 0x2000000000000)</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                {</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                    tempMant &gt;&gt;= 1;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                    tempExp++;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                }</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                this-&gt;value = (tempExp &lt;&lt; 48) | tempMant;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            }</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            {</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                this-&gt;value = temp.value;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            }</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        }</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        {</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            cnt = (this-&gt;value &gt;&gt; 48) - (temp.value &gt;&gt; 48);</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            <span class="keywordflow">if</span>(cnt &lt; 48)</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;            {</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                tempExp = (this-&gt;value &gt;&gt; 48);</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                temp.value &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                temp.value |= 0x0001000000000000;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                temp.value &gt;&gt;= cnt;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                tempMant = (this-&gt;value &amp; 0x0000FFFFFFFFFFFF) | 0x0001000000000000;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                tempMant += temp.value;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                <span class="keywordflow">while</span>(tempMant &gt; 0x2000000000000)</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                {</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                    tempMant &gt;&gt;= 1;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                    tempExp++;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                }</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                this-&gt;value = (tempExp &lt;&lt; 48) | tempMant;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;            }</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        }</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    }   </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>((this-&gt;value &gt;&gt; 56) == 1)</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    {</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        this-&gt;value &amp;= 0x00FFFFFFFFFFFFFF;  <span class="comment">//clear sign bit, to consider absolute value</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keywordflow">if</span>(*<span class="keyword">this</span> &lt;= temp)</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        {</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            cnt = (temp.value &gt;&gt; 48) - (this-&gt;value &gt;&gt; 48);</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;            <span class="keywordflow">if</span>(cnt &lt; 48)</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;            {</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                tempExp = (temp.value &gt;&gt; 48);</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                this-&gt;value &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                this-&gt;value |= 0x0001000000000000;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                this-&gt;value &gt;&gt;= cnt;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                tempMant = (temp.value &amp; 0x0000FFFFFFFFFFFF) | 0x0001000000000000;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                tempMant -= this-&gt;value;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                <span class="keywordflow">if</span>(tempMant &gt; 0x8000000000000000)</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                {</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                    tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                    tempExp--;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                }</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                <span class="keywordflow">while</span>(tempMant &lt; 0x1000000000000)</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                {</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                    tempMant &lt;&lt;= 1;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                    tempExp--;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                }</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                this-&gt;value = (tempExp &lt;&lt; 48) | tempMant;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;            }</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            {</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                this-&gt;value = temp.value;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;            }</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        }</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        {</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;            cnt = (this-&gt;value &gt;&gt; 48) - (temp.value &gt;&gt; 48);</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;            <span class="keywordflow">if</span>(cnt &lt; 48)</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;            {</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                tempExp = (this-&gt;value &gt;&gt; 48);</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                temp.value &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                temp.value |= 0x0001000000000000;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                temp.value &gt;&gt;= cnt;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                tempMant = (this-&gt;value &amp; 0x0000FFFFFFFFFFFF) | 0x0001000000000000;</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                tempMant -= temp.value;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                <span class="keywordflow">if</span>(tempMant &gt; 0x8000000000000000)</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                {</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                    tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                    tempExp--;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                }</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                <span class="keywordflow">while</span>(tempMant &lt; 0x1000000000000)</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                {</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                    tempMant &lt;&lt;= 1;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                    tempExp--;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                }</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                this-&gt;value = (tempExp &lt;&lt; 48) | tempMant;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                this-&gt;value |= 0x0100000000000000;              </div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;            }</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        }</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    }</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    {</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        temp.value &amp;= 0x00FFFFFFFFFFFFFF;   <span class="comment">//clear sign bit, to consider absolute value</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        <span class="keywordflow">if</span>(temp &lt;= *<span class="keyword">this</span>)</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        {</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;            cnt = (this-&gt;value &gt;&gt; 48) - (temp.value &gt;&gt; 48);</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;            <span class="keywordflow">if</span>(cnt &lt; 48)</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            {</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                tempExp = (this-&gt;value &gt;&gt; 48);</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                temp.value &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                temp.value |= 0x0001000000000000;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                temp.value &gt;&gt;= cnt;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                tempMant = (this-&gt;value &amp; 0x0000FFFFFFFFFFFF) | 0x0001000000000000;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                tempMant -= temp.value;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                <span class="keywordflow">if</span>(tempMant &gt; 0x8000000000000000)</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                {</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                    tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                    tempExp--;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                }</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                <span class="keywordflow">while</span>(tempMant &lt; 0x1000000000000)</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                {</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                    tempMant &lt;&lt;= 1;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                    tempExp--;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                }</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                this-&gt;value = (tempExp &lt;&lt; 48) | tempMant;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            }</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        }</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        {</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            cnt = (temp.value &gt;&gt; 48) - (this-&gt;value &gt;&gt; 48);</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            <span class="keywordflow">if</span>(cnt &lt; 48)</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;            {</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                tempExp = (temp.value &gt;&gt; 48);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                this-&gt;value &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                this-&gt;value |= 0x0001000000000000;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                this-&gt;value &gt;&gt;= cnt;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                tempMant = (temp.value &amp; 0x0000FFFFFFFFFFFF) | 0x0001000000000000;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                tempMant -= this-&gt;value;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                <span class="keywordflow">if</span>(tempMant &gt; 0x8000000000000000)</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                {</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                    tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                    tempExp--;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                }</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                <span class="keywordflow">while</span>(tempMant &lt; 0x1000000000000)</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                {</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                    tempMant &lt;&lt;= 1;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                    tempExp--;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                }</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                tempMant &amp;= 0x0000FFFFFFFFFFFF;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                this-&gt;value = (tempExp &lt;&lt; 48) | tempMant;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                this-&gt;value |= 0x0100000000000000;              </div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;            }</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            {</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                this-&gt;value = temp.value;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                this-&gt;value |= 0x0100000000000000;</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;            }</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        }</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    }</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;}</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div>
<div class="line"><a name="l00632"></a><span class="lineno"><a class="line" href="classuStepperTemp.html#ae22b3413a9c687e8832b62dd06d0e943">  632</a></span>&#160;<a class="code" href="classuStepperTemp.html#ae22b3413a9c687e8832b62dd06d0e943">uStepperTemp::uStepperTemp</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;{</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;}</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;</div>
<div class="line"><a name="l00637"></a><span class="lineno"><a class="line" href="classuStepperTemp.html#a9ddadd3aadbd94e0f0290ebccf05ae2d">  637</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classuStepperTemp.html#a9ddadd3aadbd94e0f0290ebccf05ae2d">uStepperTemp::getTemp</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;{</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keywordtype">float</span> T = 0.0;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="keywordtype">float</span> Vout = 0.0;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <span class="keywordtype">float</span> NTC = 0.0;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    Vout = analogRead(TEMP)*0.0048828125;   <span class="comment">//0.0048828125 = 5V/1024</span></div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    NTC = ((<a class="code" href="uStepper_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>*5.0)/Vout)-<a class="code" href="uStepper_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;                         <span class="comment">//the current NTC resistance</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    NTC = log(NTC);</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    T = <a class="code" href="uStepper_8h.html#a955f504eccf76b4eb2489c0adab03121">A</a> + <a class="code" href="uStepper_8h.html#a111da81ae5883147168bbb8366377b10">B</a>*NTC + <a class="code" href="uStepper_8h.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>*NTC*NTC*NTC;                  <span class="comment">//Steinhart-Hart equation</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    T = 1.0/T;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    <span class="keywordflow">return</span> T - 273.15;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;}</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div>
<div class="line"><a name="l00652"></a><span class="lineno"><a class="line" href="classuStepperEncoder.html#ab9c80a99fca938eeb490e4ed8d109f04">  652</a></span>&#160;<a class="code" href="classuStepperEncoder.html#ab9c80a99fca938eeb490e4ed8d109f04">uStepperEncoder::uStepperEncoder</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;{</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#af639b1fb501c7530afdca5e87a56168f">begin</a>();</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;}</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;</div>
<div class="line"><a name="l00657"></a><span class="lineno"><a class="line" href="classuStepperEncoder.html#a29117f4952ff99ba53b90b842f4e69f1">  657</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classuStepperEncoder.html#a29117f4952ff99ba53b90b842f4e69f1">uStepperEncoder::getAngleMoved</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;{<span class="comment">/*</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="comment">    float deltaAngle, angle;</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="comment">    TIMSK1 &amp;= ~(1 &lt;&lt; OCIE1A);</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="comment">    angle = this-&gt;getAngle() - this-&gt;encoderOffset;</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="comment">    if(angle &lt; 0.0)</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="comment">        angle += 360.0;</span></div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="comment">    deltaAngle = this-&gt;oldAngle - angle;</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="comment">    if(deltaAngle &lt; -180.0)</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="comment">        pointer-&gt;encoder.angleMoved += (deltaAngle + 360.0); </span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">    else if(deltaAngle &gt; 180.0)</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="comment">        pointer-&gt;encoder.angleMoved -= (360.0 - deltaAngle); </span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="comment">    else</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="comment">        this-&gt;angleMoved += deltaAngle;</span></div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="comment">    this-&gt;oldAngle = angle;</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="comment">    TIMSK1 |= (1 &lt;&lt; OCIE1A);*/</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    <span class="keywordflow">return</span> this-&gt;<a class="code" href="classuStepperEncoder.html#a5185708424b99dd13bbe6d9f0ad4f603">angleMoved</a>;</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;}</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div>
<div class="line"><a name="l00695"></a><span class="lineno"><a class="line" href="classuStepperEncoder.html#a8812beadc9bec6f4e321d281d9b6ea79">  695</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classuStepperEncoder.html#a8812beadc9bec6f4e321d281d9b6ea79">uStepperEncoder::getSpeed</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;{</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    <span class="keywordflow">return</span> this-&gt;<a class="code" href="classuStepperEncoder.html#afe0647659291c6ed4f4104e95f5ae047">curSpeed</a>;</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;}</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div>
<div class="line"><a name="l00700"></a><span class="lineno"><a class="line" href="classuStepperEncoder.html#a6d391ceaf50957f3d1ae8736a4c60d76">  700</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepperEncoder.html#a6d391ceaf50957f3d1ae8736a4c60d76">uStepperEncoder::setup</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;{</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    uint8_t data[2];</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    TCCR1A = 0;</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    TCNT1 = 0;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    OCR1A = 16000;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    TIFR1 = 0;</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    TIMSK1 = (1 &lt;&lt; OCIE1A);</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    TCCR1B = (1 &lt;&lt; WGM12) | (1 &lt;&lt; CS10);</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#a9d56b4ea47659456f19cff59ac96d5f9">read</a>(<a class="code" href="uStepper_8h.html#a2e619f47c3bc5b6af8ea904dbf5c98fe">ENCODERADDR</a>, <a class="code" href="uStepper_8h.html#a8a7f485573c16394fc0792a66bd02c7a">ANGLE</a>, 2, data);</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    this-&gt;<a class="code" href="classuStepperEncoder.html#a732a1d71de7978312f24a70b8c1301a4">encoderOffset</a> = (float)((((uint16_t)data[0]) &lt;&lt; 8 ) | (uint16_t)data[1])*0.087890625;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    this-&gt;<a class="code" href="classuStepperEncoder.html#a372f52c9553676ebb2ea08f6624f3042">oldAngle</a> = 0.0;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    this-&gt;<a class="code" href="classuStepperEncoder.html#a5185708424b99dd13bbe6d9f0ad4f603">angleMoved</a> = 0.0;</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    sei();</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;}</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div>
<div class="line"><a name="l00719"></a><span class="lineno"><a class="line" href="classuStepperEncoder.html#abf3fc82540c092e8a6c68d4580bedbf9">  719</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepperEncoder.html#abf3fc82540c092e8a6c68d4580bedbf9">uStepperEncoder::setHome</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;{</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    cli();</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    uint8_t data[2];</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#a9d56b4ea47659456f19cff59ac96d5f9">read</a>(<a class="code" href="uStepper_8h.html#a2e619f47c3bc5b6af8ea904dbf5c98fe">ENCODERADDR</a>, <a class="code" href="uStepper_8h.html#a8a7f485573c16394fc0792a66bd02c7a">ANGLE</a>, 2, data);</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    this-&gt;<a class="code" href="classuStepperEncoder.html#a732a1d71de7978312f24a70b8c1301a4">encoderOffset</a> = (float)((((uint16_t)data[0]) &lt;&lt; 8 ) | (uint16_t)data[1])*0.087890625;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    this-&gt;angle = 0.0;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    this-&gt;<a class="code" href="classuStepperEncoder.html#a372f52c9553676ebb2ea08f6624f3042">oldAngle</a> = 0.0;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    this-&gt;<a class="code" href="classuStepperEncoder.html#a5185708424b99dd13bbe6d9f0ad4f603">angleMoved</a> = 0.0;</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    sei();</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;}</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div>
<div class="line"><a name="l00732"></a><span class="lineno"><a class="line" href="classuStepperEncoder.html#abf760d7949e75977bf11bce48256283c">  732</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classuStepperEncoder.html#abf760d7949e75977bf11bce48256283c">uStepperEncoder::getAngle</a>()</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;{</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keywordflow">return</span> this-&gt;angle;</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;}</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;</div>
<div class="line"><a name="l00737"></a><span class="lineno"><a class="line" href="classuStepperEncoder.html#a26b81725b7a995fed98de0fcdd614b1f">  737</a></span>&#160;uint16_t <a class="code" href="classuStepperEncoder.html#a26b81725b7a995fed98de0fcdd614b1f">uStepperEncoder::getStrength</a>()</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;{</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    uint8_t data[2];</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#a9d56b4ea47659456f19cff59ac96d5f9">read</a>(<a class="code" href="uStepper_8h.html#a2e619f47c3bc5b6af8ea904dbf5c98fe">ENCODERADDR</a>, <a class="code" href="uStepper_8h.html#acaa6e10cd07d7a2e7fda09e5f0821858">MAGNITUDE</a>, 2, data);</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    <span class="keywordflow">return</span> (((uint16_t)data[0]) &lt;&lt; 8 )| (uint16_t)data[1];</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;}</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;</div>
<div class="line"><a name="l00746"></a><span class="lineno"><a class="line" href="classuStepperEncoder.html#a8a4a9e8dab1412c67de52b4454050d3e">  746</a></span>&#160;uint8_t <a class="code" href="classuStepperEncoder.html#a8a4a9e8dab1412c67de52b4454050d3e">uStepperEncoder::getAgc</a>()</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;{</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    uint8_t data;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#a9d56b4ea47659456f19cff59ac96d5f9">read</a>(<a class="code" href="uStepper_8h.html#a2e619f47c3bc5b6af8ea904dbf5c98fe">ENCODERADDR</a>, <a class="code" href="uStepper_8h.html#acaa6e10cd07d7a2e7fda09e5f0821858">MAGNITUDE</a>, 1, &amp;data);</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    <span class="keywordflow">return</span> data;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;}</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;</div>
<div class="line"><a name="l00755"></a><span class="lineno"><a class="line" href="classuStepperEncoder.html#a990203acc3069947412e0a9dd36bc988">  755</a></span>&#160;uint8_t <a class="code" href="classuStepperEncoder.html#a990203acc3069947412e0a9dd36bc988">uStepperEncoder::detectMagnet</a>()</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;{</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    uint8_t data;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#a9d56b4ea47659456f19cff59ac96d5f9">read</a>(<a class="code" href="uStepper_8h.html#a2e619f47c3bc5b6af8ea904dbf5c98fe">ENCODERADDR</a>, <a class="code" href="uStepper_8h.html#a6b14c0a97e1a526bf898cd24de183afb">AGC</a>, 1, &amp;data);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    data &amp;= 0x38;                   <span class="comment">//For some reason the encoder returns random values on reserved bits. Therefore we make sure reserved bits are cleared before checking the reply !</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <span class="keywordflow">if</span>(data == 0x08)</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    {</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        <span class="keywordflow">return</span> 1;                   <span class="comment">//magnet too strong</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    }</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(data == 0x10)</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    {</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        <span class="keywordflow">return</span> 2;                   <span class="comment">//magnet too weak</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    }</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(data == 0x20)</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    {</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="keywordflow">return</span> 0;                   <span class="comment">//magnet detected and within limits</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    }</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="keywordflow">return</span> 3;                       <span class="comment">//Something went horribly wrong !</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;}</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;</div>
<div class="line"><a name="l00781"></a><span class="lineno"><a class="line" href="classuStepper.html#a554b67202deeb611116ba62383ecb783">  781</a></span>&#160;<a class="code" href="classuStepper.html#a554b67202deeb611116ba62383ecb783">uStepper::uStepper</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;{</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a97998e6f4b3f6eac8226d4670548edf0">setMaxAcceleration</a>(1000.0);</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a3058a91bbd7ee379127b8ff354d8cdff">setMaxVelocity</a>(1000.0);</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    pointer = <span class="keyword">this</span>;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    DDRD |= (1 &lt;&lt; 7);       <span class="comment">//set direction pin to output</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    DDRD |= (1 &lt;&lt; 4);       <span class="comment">//set step pin to output</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    DDRB |= (1 &lt;&lt; 0);       <span class="comment">//set enable pin to output</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;}</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;</div>
<div class="line"><a name="l00796"></a><span class="lineno"><a class="line" href="classuStepper.html#a0a9ffcf75de9ed390585f0b0bde385fd">  796</a></span>&#160;<a class="code" href="classuStepper.html#a554b67202deeb611116ba62383ecb783">uStepper::uStepper</a>(<span class="keywordtype">float</span> accel, <span class="keywordtype">float</span> vel)</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;{</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a3058a91bbd7ee379127b8ff354d8cdff">setMaxVelocity</a>(vel);</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a97998e6f4b3f6eac8226d4670548edf0">setMaxAcceleration</a>(accel);</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    pointer = <span class="keyword">this</span>;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    DDRD |= (1 &lt;&lt; 7);       <span class="comment">//set direction pin to output</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    DDRD |= (1 &lt;&lt; 4);       <span class="comment">//set step pin to output</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    DDRB |= (1 &lt;&lt; 0);       <span class="comment">//set enable pin to output</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;}</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;</div>
<div class="line"><a name="l00810"></a><span class="lineno"><a class="line" href="classuStepper.html#a97998e6f4b3f6eac8226d4670548edf0">  810</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#a97998e6f4b3f6eac8226d4670548edf0">uStepper::setMaxAcceleration</a>(<span class="keywordtype">float</span> accel)</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;{</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a> = accel;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4">stopTimer</a>();          <span class="comment">//Stop timer so we dont fuck up stuff !</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a7d69fe56b00bbdc535901d96c1504fff">multiplier</a>.setValue((this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>/(<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>*<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>)));  <span class="comment">//Recalculate multiplier variable, used by the acceleration algorithm since acceleration has changed!</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    </div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> != <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>)</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    {</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#a3f2726a90ba7379b1d079d7d86368f5b">continous</a> == 1)    <span class="comment">//If motor was running continously</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        {</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a963e4d53e856238e5a4f54be38b8a8b3">runContinous</a>(this-&gt;<a class="code" href="classuStepper.html#aa734971bf8fee35c4a919ee080f020a7">direction</a>);    <span class="comment">//We should make it run continously again</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        }</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        <span class="keywordflow">else</span>                        <span class="comment">//If motor still needs to perform some steps</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;        {</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a1fdc8d8673b58ac5dbd23652128d55c0">moveSteps</a>(this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a1decfd6218df74c13ba70b55c47d3c2b">currentStep</a> + 1, this-&gt;<a class="code" href="classuStepper.html#aa734971bf8fee35c4a919ee080f020a7">direction</a>, this-&gt;<a class="code" href="classuStepper.html#a4099233d63e894e8a8e364da8334c129">hold</a>); <span class="comment">//we should make sure the motor gets to execute the remaining steps             </span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        }</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    }</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;}</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div>
<div class="line"><a name="l00830"></a><span class="lineno"><a class="line" href="classuStepper.html#a352e4b96324adfe1feb66ab4f88c3745">  830</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classuStepper.html#a352e4b96324adfe1feb66ab4f88c3745">uStepper::getMaxAcceleration</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;{<span class="comment">/*</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="comment">    Serial.print(this-&gt;exactDelay.getFloatValue(),15);</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="comment">    Serial.print(&quot;\t&quot;);</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="comment">    Serial.print(this-&gt;delay);</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">    Serial.print(&quot;\t&quot;);</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment">    Serial.print((uint8_t)((this-&gt;exactDelay.value &gt;&gt; 48) &amp; 0x00000000000000FF),HEX);</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="comment">    Serial.print(&quot; &quot;);</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;<span class="comment">    Serial.print((uint8_t)((this-&gt;exactDelay.value &gt;&gt; 40) &amp; 0x00000000000000FF),HEX);</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="comment">    Serial.print(&quot; &quot;);</span></div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="comment">    Serial.print((uint8_t)((this-&gt;exactDelay.value &gt;&gt; 32) &amp; 0x00000000000000FF),HEX);</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="comment">    Serial.print(&quot; &quot;);</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;<span class="comment">    Serial.print((uint8_t)((this-&gt;exactDelay.value &gt;&gt; 24) &amp; 0x00000000000000FF),HEX);</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;<span class="comment">    Serial.print(&quot; &quot;);</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="comment">    Serial.print((uint8_t)((this-&gt;exactDelay.value &gt;&gt; 16) &amp; 0x00000000000000FF),HEX);</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="comment">    Serial.print(&quot; &quot;);</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="comment">    Serial.print((uint8_t)((this-&gt;exactDelay.value &gt;&gt; 8) &amp; 0x00000000000000FF),HEX);</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="comment">    Serial.print(&quot; &quot;);</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="comment">    Serial.print((uint8_t)((this-&gt;exactDelay.value) &amp; 0x00000000000000FF),HEX);</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="comment">    Serial.print(&quot;\t&quot;);</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="comment">    Serial.print(this-&gt;delay);</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="comment">    Serial.print(&quot;\t&quot;);</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="comment">    Serial.println(this-&gt;totalSteps);*/</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    <span class="comment">/*cli();</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="comment">    float tmp=this-&gt;exactDelay.getFloatValue();</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="comment">    sei();</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="comment">    return tmp;*/</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;    <span class="keywordflow">return</span> this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;}</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div>
<div class="line"><a name="l00860"></a><span class="lineno"><a class="line" href="classuStepper.html#a3058a91bbd7ee379127b8ff354d8cdff">  860</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#a3058a91bbd7ee379127b8ff354d8cdff">uStepper::setMaxVelocity</a>(<span class="keywordtype">float</span> vel)</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;{</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="keywordflow">if</span>(vel &lt; 0.5005)</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    {</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a> = 0.5005;            <span class="comment">//Limit velocity in order to not overflow delay variable</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    }</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(vel &gt; 32000.0)</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    {</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a> = 32000.0;           <span class="comment">//limit velocity in order to not underflow delay variable</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    }</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    {</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a> = vel;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    }</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4">stopTimer</a>();          <span class="comment">//Stop timer so we dont fuck up stuff !</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#aecedcc41a09006be3d2f671c6732b615">cruiseDelay</a> = (uint16_t)((<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>) - 0.5); <span class="comment">//Calculate cruise delay, so we dont have to recalculate this in the interrupt routine</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    </div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> != <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>)     <span class="comment">//If motor was running, we should make sure it runs again</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    {</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#a3f2726a90ba7379b1d079d7d86368f5b">continous</a> == 1)    <span class="comment">//If motor was running continously</span></div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        {</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a963e4d53e856238e5a4f54be38b8a8b3">runContinous</a>(this-&gt;<a class="code" href="classuStepper.html#aa734971bf8fee35c4a919ee080f020a7">direction</a>);    <span class="comment">//We should make it run continously again</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        }</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        <span class="keywordflow">else</span>                    <span class="comment">//If motor still needs to perform some steps</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        {</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a1fdc8d8673b58ac5dbd23652128d55c0">moveSteps</a>(this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a1decfd6218df74c13ba70b55c47d3c2b">currentStep</a> + 1, this-&gt;<a class="code" href="classuStepper.html#aa734971bf8fee35c4a919ee080f020a7">direction</a>, this-&gt;<a class="code" href="classuStepper.html#a4099233d63e894e8a8e364da8334c129">hold</a>); <span class="comment">//we should make sure it gets to execute these steps    </span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        }</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    }</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;}</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div>
<div class="line"><a name="l00893"></a><span class="lineno"><a class="line" href="classuStepper.html#a1e88bdd345aba07f23409df7d7f93a89">  893</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="classuStepper.html#a1e88bdd345aba07f23409df7d7f93a89">uStepper::getMaxVelocity</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;{</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="keywordflow">return</span> this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>;</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;}</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div>
<div class="line"><a name="l00898"></a><span class="lineno"><a class="line" href="classuStepper.html#a963e4d53e856238e5a4f54be38b8a8b3">  898</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#a963e4d53e856238e5a4f54be38b8a8b3">uStepper::runContinous</a>(<span class="keywordtype">bool</span> dir)</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;{</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <span class="keywordtype">float</span> curVel;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="keywordflow">if</span>(this-&gt;dropIn)</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    {</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        <span class="keywordflow">return</span>;     <span class="comment">//Drop in feature is activated. just return since this function makes no sense with drop in activated!</span></div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    }</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    </div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4">stopTimer</a>();              <span class="comment">//Stop interrupt timer, so we don&#39;t fuck up stuff !</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a3f2726a90ba7379b1d079d7d86368f5b">continous</a> = 1;            <span class="comment">//Set continous variable to 1, in order to let the interrupt routine now, that the motor should run continously</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#aa734971bf8fee35c4a919ee080f020a7">direction</a> = dir;</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    </div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> != <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>)                                       <span class="comment">//if the motor is currently running and we want to move the opposite direction, we need to decelerate in order to change direction.</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    {</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        curVel = <a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue();                              <span class="comment">//Use this to calculate current velocity</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        <span class="keywordflow">if</span>(dir != digitalRead(DIR))                         <span class="comment">//If motor is currently running the opposite direction as desired</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        {</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#a0c1151fb74132a2a24a1483ca529d511">INITDECEL</a>;                            <span class="comment">//We should decelerate the motor to full stop before accelerating the speed in the opposite direction</span></div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> = (uint32_t)(((curVel*curVel))/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));       <span class="comment">//the amount of steps needed to bring the motor to full stop. (S = (V^2 - V0^2)/(2*-a)))</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = (uint32_t)((this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>*this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>)/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));            <span class="comment">//Number of steps to bring the motor to max speed (S = (V^2 - V0^2)/(2*a)))</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.setValue(<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/sqrt((curVel*curVel) + 2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));  <span class="comment">//number of interrupts before the first step should be performed.</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;            <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() &gt;= 65535.5)</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;            {</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = 0xFFFF;</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;            }</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;            {</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = (uint16_t)(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() - 0.5);       <span class="comment">//Truncate the exactDelay variable, since we cant perform fractional steps</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;            }</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        }</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        <span class="keywordflow">else</span>                                                <span class="comment">//If the motor is currently rotating the same direction as the desired direction</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        {</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;            <span class="keywordflow">if</span>(curVel &gt; this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>)                     <span class="comment">//If current velocity is greater than desired velocity</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;            {</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#a0c1151fb74132a2a24a1483ca529d511">INITDECEL</a>;                        <span class="comment">//We need to decelerate the motor to desired velocity</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> = (uint32_t)(((this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>*this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>) - (curVel*curVel))/(-2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));        <span class="comment">//Number of steps to bring the motor down from current speed to max speed (S = (V^2 - V0^2)/(2*-a)))</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = 0;                       <span class="comment">//No acceleration phase is needed</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;            }</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(curVel &lt; this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>)                    <span class="comment">//If the current velocity is less than the desired velocity</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;            {</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#ad2d7243c099b33b2343976dd3ee8b36b">ACCEL</a>;                            <span class="comment">//Start accelerating</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = (uint32_t)(((this-&gt;velocity*this-&gt;velocity) - (curVel*curVel))/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));    <span class="comment">//Number of Steps needed to accelerate from current velocity to full speed</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;            }</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;            <span class="keywordflow">else</span>                                            <span class="comment">//If motor is currently running at desired speed</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;            {</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#afe63280e8006a836668a21fa62ed7630">CRUISE</a>;                       <span class="comment">//We should just run at cruise speed</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;            }</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        }</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    }</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    <span class="keywordflow">else</span>                                                                                        <span class="comment">//If motor is currently stopped (state = STOP)</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    {</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#ad2d7243c099b33b2343976dd3ee8b36b">ACCEL</a>;                                                                    <span class="comment">//Start accelerating</span></div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        <span class="keywordflow">if</span>(dir)                                                                 <span class="comment">//Set the motor direction pin to the desired setting</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        {</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;            PORTD |= (1 &lt;&lt; 7);</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        }</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        {</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;            PORTD &amp;= ~(1 &lt;&lt; 7);</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        }</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = (<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>*<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>)/(2.0*<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>);                              <span class="comment">//Number of steps to bring the motor to max speed (S = (V^2 - V0^2)/(2*a)))</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        </div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.setValue(<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/sqrt(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));    <span class="comment">//number of interrupts before the first step should be performed.</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        </div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() &gt; 65535.0)</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        {</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = 0xFFFF;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        }</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        {</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = (uint16_t)(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() - 0.5);       <span class="comment">//Truncate the exactDelay variable, since we cant perform fractional steps</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;        }</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;    }</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    </div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#aa3a08ba0871ec3fd1f0deba270d9bacf">startTimer</a>();                                                                         <span class="comment">//start timer so we can perform steps</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#addb2dd84de1d152201ee5320d5fe1308">enableMotor</a>();                                                                            <span class="comment">//Enable motor</span></div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;}</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;</div>
<div class="line"><a name="l00984"></a><span class="lineno"><a class="line" href="classuStepper.html#a1fdc8d8673b58ac5dbd23652128d55c0">  984</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#a1fdc8d8673b58ac5dbd23652128d55c0">uStepper::moveSteps</a>(uint32_t steps, <span class="keywordtype">bool</span> dir, <span class="keywordtype">bool</span> holdMode)</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;{</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;    <span class="keywordtype">float</span> curVel;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;    <span class="keywordflow">if</span>(this-&gt;dropIn)</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    {</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        <span class="keywordflow">return</span>;     <span class="comment">//Drop in feature is activated. just return since this function makes no sense with drop in activated!</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;    }</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4">stopTimer</a>();                  <span class="comment">//Stop interrupt timer so we dont fuck stuff up !</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;    steps--;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#aa734971bf8fee35c4a919ee080f020a7">direction</a> = dir;              <span class="comment">//Set direction variable to the desired direction of rotation for the interrupt routine</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a4099233d63e894e8a8e364da8334c129">hold</a> = holdMode;              <span class="comment">//Set the hold variable to desired hold mode (block motor or release motor after end movement) for the interrupt routine</span></div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> = steps;           <span class="comment">//Load the desired number of steps into the totalSteps variable for the interrupt routine</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a3f2726a90ba7379b1d079d7d86368f5b">continous</a> = 0;                <span class="comment">//Set continous variable to 0, since the motor should not run continous</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> != <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>)                   <span class="comment">//if the motor is currently running and we want to move the opposite direction, we need to decelerate in order to change direction.</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    {</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        curVel = <a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue();                              <span class="comment">//Use this to calculate current velocity</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        <span class="keywordflow">if</span>(dir != digitalRead(DIR))                                 <span class="comment">//If current direction is different from desired direction</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;        {</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#a0c1151fb74132a2a24a1483ca529d511">INITDECEL</a>;                                    <span class="comment">//We should decelerate the motor to full stop</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> = (uint32_t)((curVel*curVel)/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));     <span class="comment">//the amount of steps needed to bring the motor to full stop. (S = (V^2 - V0^2)/(2*-a)))</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = (uint32_t)((this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a> * this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>)/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));                                  <span class="comment">//Number of steps to bring the motor to max speed (S = (V^2 - V0^2)/(2*a)))</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> += this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a>;                <span class="comment">//Add the steps used for initial deceleration to the totalSteps variable, since we moved this number of steps, passed the initial position, and therefore need to move this amount of steps extra, in the desired direction</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;            <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> &gt; (this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> &gt;&gt; 1))          <span class="comment">//If we need to accelerate for longer than half of the total steps, we need to start decelerating before we reach max speed</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;            {</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> = (this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> &gt;&gt; 1);  <span class="comment">//Accelerate and decelerate for the same amount of steps (half the total steps)</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> += this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>;             <span class="comment">//If there are still a step left to perform, due to rounding errors, do this step as an acceleration step   </span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;            }</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;            {</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> = this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a>;                    <span class="comment">//If top speed is reached before half the total steps are performed, deceleration period should be same length as acceleration period</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>;             <span class="comment">//Perform remaining steps, as cruise steps</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;            }</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.setValue(<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/sqrt((curVel*curVel) + 2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));  <span class="comment">//number of interrupts before the first step should be performed.</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;            <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() &gt;= 65535.5)</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;            {</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = 0xFFFF;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;            }</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;            {</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = (uint16_t)(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() - 0.5);       <span class="comment">//Truncate the exactDelay variable, since we cant perform fractional steps</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;            }</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        }</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        <span class="keywordflow">else</span>                            <span class="comment">//If the motor is currently rotating the same direction as desired, we dont necessarily need to decelerate</span></div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        {</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            <span class="keywordflow">if</span>(curVel &gt; this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>) <span class="comment">//If current velocity is greater than desired velocity</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;            {</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#a0c1151fb74132a2a24a1483ca529d511">INITDECEL</a>;    <span class="comment">//We need to decelerate the motor to desired velocity</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> = (uint32_t)(((this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>*this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>) - (curVel*curVel))/(-2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));        <span class="comment">//Number of steps to bring the motor down from current speed to max speed (S = (V^2 - V0^2)/(2*-a)))</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = 0;   <span class="comment">//No acceleration phase is needed</span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> = (uint32_t)((this-&gt;velocity*this-&gt;velocity)/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));    <span class="comment">//Number of steps needed to decelerate the motor from top speed to full stop</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.setValue((<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/sqrt((curVel*curVel) + 2*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>)));</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;                <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> &lt;= (this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> + this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>))</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                {</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;                    this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = 0;</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                }</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;                {</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;                    this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = steps - this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>;                 <span class="comment">//Perform remaining steps as cruise steps</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                }</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                </div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;            }</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(curVel &lt; this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>)    <span class="comment">//If current velocity is less than desired velocity</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;            {</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#ad2d7243c099b33b2343976dd3ee8b36b">ACCEL</a>;            <span class="comment">//Start accelerating</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = (uint32_t)(((this-&gt;velocity*this-&gt;velocity) - (curVel*curVel))/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));    <span class="comment">//Number of Steps needed to accelerate from current velocity to full speed</span></div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;                <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> &gt; (this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> &gt;&gt; 1))          <span class="comment">//If we need to accelerate for longer than half of the total steps, we need to start decelerating before we reach max speed</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                {</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                    this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> = (this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> &gt;&gt; 1);  <span class="comment">//Accelerate and decelerate for the same amount of steps (half the total steps)</span></div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                    this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> += this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>;             <span class="comment">//If there are still a step left to perform, due to rounding errors, do this step as an acceleration step   </span></div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                    this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = 0;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                }</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                {</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                    this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> = this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a>;                    <span class="comment">//If top speed is reached before half the total steps are performed, deceleration period should be same length as acceleration period</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;                    this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>;             <span class="comment">//Perform remaining steps, as cruise steps</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                }</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = steps - this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>;    <span class="comment">//Perform remaining steps as cruise steps</span></div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> = 0;                                <span class="comment">//No initial deceleration phase needed</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;            }</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;            <span class="keywordflow">else</span>                        <span class="comment">//If current velocity is equal to desired velocity</span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;            {</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#afe63280e8006a836668a21fa62ed7630">CRUISE</a>;   <span class="comment">//We are already at desired speed, therefore we start at cruise phase</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> = (uint32_t)((this-&gt;velocity*this-&gt;velocity)/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));    <span class="comment">//Number of steps needed to decelerate the motor from top speed to full stop</span></div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = 0;   <span class="comment">//No acceleration phase needed</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> = 0;        <span class="comment">//No initial deceleration phase needed</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;                <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> &gt;= this-&gt;<a class="code" href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">totalSteps</a>)</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;                {</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                    this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = 0;</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;                }</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;                {</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                    this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = steps - this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>;   <span class="comment">//Perform remaining steps as cruise steps</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;                }</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            }</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        }</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    }</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    </div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    <span class="keywordflow">else</span>                                <span class="comment">//If motor is currently at full stop (state = STOP)</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    {</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        <span class="keywordflow">if</span>(dir)                                                                 <span class="comment">//Set the motor direction pin to the desired setting</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;        {</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;            PORTD |= (1 &lt;&lt; 7);</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        }</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        {</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;            PORTD &amp;= ~(1 &lt;&lt; 7);</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;        }</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#ad2d7243c099b33b2343976dd3ee8b36b">ACCEL</a>;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = (uint32_t)((this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a> * this-&gt;<a class="code" href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">velocity</a>)/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));  <span class="comment">//Number of steps to bring the motor to max speed (S = (V^2 - V0^2)/(2*a)))</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> = 0;        <span class="comment">//No initial deceleration phase needed</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> &gt; (steps &gt;&gt; 1)) <span class="comment">//If we need to accelerate for longer than half of the total steps, we need to start decelerating before we reach max speed</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        {</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = 0;      <span class="comment">//No cruise phase needed</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> = (steps &gt;&gt; 1);             <span class="comment">//Accelerate and decelerate for the same amount of steps (half the total steps)</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> += steps - this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>;    <span class="comment">//if there are still a step left to perform, due to rounding errors, do this step as an acceleration step   </span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        }</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        <span class="keywordflow">else</span>                                </div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;        {</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> = this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a>;    <span class="comment">//If top speed is reached before half the total steps are performed, deceleration period should be same length as acceleration period</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = steps - this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> - this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a>;    <span class="comment">//Perform remaining steps as cruise steps</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        }</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.setValue(<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/sqrt(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));    <span class="comment">//number of interrupts before the first step should be performed.</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() &gt; 65535.0)</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        {</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = 0xFFFF;</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        }</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        {</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = (uint16_t)(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() - 0.5);       <span class="comment">//Truncate the exactDelay variable, since we cant perform fractional steps</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;        }</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    }</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#aa3a08ba0871ec3fd1f0deba270d9bacf">startTimer</a>();                                 <span class="comment">//start timer so we can perform steps</span></div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#addb2dd84de1d152201ee5320d5fe1308">enableMotor</a>();                                    <span class="comment">//Enable motor driver</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;}</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;</div>
<div class="line"><a name="l01137"></a><span class="lineno"><a class="line" href="classuStepper.html#a03884a4ae4613bd574d1d87e6658a5e8"> 1137</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#a03884a4ae4613bd574d1d87e6658a5e8">uStepper::hardStop</a>(<span class="keywordtype">bool</span> holdMode)</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;{</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    <span class="keywordflow">if</span>(this-&gt;dropIn)</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    {</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;        <span class="keywordflow">return</span>;     <span class="comment">//Drop in feature is activated. just return since this function makes no sense with drop in activated!</span></div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;    }</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4">stopTimer</a>();          <span class="comment">//Stop interrupt timer, since we shouldn&#39;t perform more steps</span></div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a4099233d63e894e8a8e364da8334c129">hold</a> = holdMode;</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> != <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>)</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    {</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>;         <span class="comment">//Set current state to STOP</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#aa3a08ba0871ec3fd1f0deba270d9bacf">startTimer</a>();</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    }</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    {</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        <span class="keywordflow">if</span>(holdMode == <a class="code" href="uStepper_8h.html#a1b44ecf82561bec987fa3c07632335a4">SOFT</a>)</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        {</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#aba6edb2757fb57b204979a99fa0248d8">disableMotor</a>();</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        }</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        </div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (holdMode == <a class="code" href="uStepper_8h.html#a4d14a79c82f3f831303e38487811eda4">HARD</a>)</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        {</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#addb2dd84de1d152201ee5320d5fe1308">enableMotor</a>();</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;        }</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;    }</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;}</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;</div>
<div class="line"><a name="l01168"></a><span class="lineno"><a class="line" href="classuStepper.html#af5715f56bed814257f496150e032b41c"> 1168</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#af5715f56bed814257f496150e032b41c">uStepper::softStop</a>(<span class="keywordtype">bool</span> holdMode)</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;{</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;    <span class="keywordtype">float</span> curVel;</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;    <span class="keywordflow">if</span>(this-&gt;dropIn)</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;    {</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;        <span class="keywordflow">return</span>;     <span class="comment">//Drop in feature is activated. just return since this function makes no sense with drop in activated!</span></div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    }</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4">stopTimer</a>();          <span class="comment">//Stop interrupt timer, since we shouldn&#39;t perform more steps</span></div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a4099233d63e894e8a8e364da8334c129">hold</a> = holdMode;      </div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> != <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>)</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    {</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        curVel = <a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue();                              <span class="comment">//Use this to calculate current velocity</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">decelSteps</a> = (uint32_t)((curVel*curVel)/(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));        <span class="comment">//Number of steps to bring the motor down from current speed to max speed (S = (V^2 - V0^2)/(2*-a)))    </span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#a5c780ca98e925402711a3810ba873649">accelSteps</a> = this-&gt;<a class="code" href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">initialDecelSteps</a> = this-&gt;<a class="code" href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">cruiseSteps</a> = 0; <span class="comment">//Reset amount of steps in the different phases </span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> = <a class="code" href="uStepper_8h.html#a8e111344ca6ef978238061294b46c5f9">DECEL</a>;</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.setValue(<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/sqrt(2.0*this-&gt;<a class="code" href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">acceleration</a>));    <span class="comment">//number of interrupts before the first step should be performed.</span></div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() &gt; 65535.0)</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        {</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = 0xFFFF;</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        }</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        {</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">delay</a> = (uint16_t)(this-&gt;<a class="code" href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">exactDelay</a>.getFloatValue() - 0.5);       <span class="comment">//Truncate the exactDelay variable, since we cant perform fractional steps</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        }</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;        this-&gt;<a class="code" href="classuStepper.html#aa3a08ba0871ec3fd1f0deba270d9bacf">startTimer</a>();</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    }</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    {</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;        <span class="keywordflow">if</span>(holdMode == <a class="code" href="uStepper_8h.html#a1b44ecf82561bec987fa3c07632335a4">SOFT</a>)</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;        {</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#aba6edb2757fb57b204979a99fa0248d8">disableMotor</a>();</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;        }</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;        </div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (holdMode == <a class="code" href="uStepper_8h.html#a4d14a79c82f3f831303e38487811eda4">HARD</a>)</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        {</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;            this-&gt;<a class="code" href="classuStepper.html#addb2dd84de1d152201ee5320d5fe1308">enableMotor</a>();</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;        }</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    }</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;}</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;</div>
<div class="line"><a name="l01216"></a><span class="lineno"><a class="line" href="classuStepper.html#a972acc9f6df3cbea8909f1ce7d3fa3d2"> 1216</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#a972acc9f6df3cbea8909f1ce7d3fa3d2">uStepper::setup</a>(<span class="keywordtype">bool</span> mode, uint8_t microStepping, <span class="keywordtype">float</span> faultSpeed, uint32_t faultTolerance)</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;{</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    this-&gt;dropIn = mode;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;    <span class="keywordflow">if</span>(mode)</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;    {</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        pinMode(2,INPUT);</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        pinMode(3,INPUT);</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        pinMode(4,INPUT);</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;        digitalWrite(2,HIGH);</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;        digitalWrite(3,HIGH);</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;        digitalWrite(4,HIGH);</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;        this-&gt;stepResolution = 360.0/((float)(200*microStepping));</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;        this-&gt;tolerance = ((float)faultTolerance)*this-&gt;stepResolution;</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;        this-&gt;faultStepDelay = (uint16_t)((<a class="code" href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a>/faultSpeed) - 1);</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        EICRA = 0x0D;       <span class="comment">//int0 generates interrupt on any change and int1 generates interrupt on rising edge</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        EIMSK = 0x03;       <span class="comment">//enable int0 and int1 interrupt requests</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    }</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    TCCR2B &amp;= ~((1 &lt;&lt; CS20) | (1 &lt;&lt; CS21) | (1 &lt;&lt; CS22) | (1 &lt;&lt; WGM22));</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    TCCR2A &amp;= ~((1 &lt;&lt; WGM20) | (1 &lt;&lt; WGM21));</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    TCCR2B |= (1 &lt;&lt; CS21);              <span class="comment">//Enable timer with prescaler 8. interrupt base frequency ~ 7.8125kHz</span></div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    TCCR2A |= (1 &lt;&lt; WGM21);             <span class="comment">//Switch timer 2 to CTC mode, to adjust interrupt frequency</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    OCR2A = 70;                         <span class="comment">//Change top value to 60 in order to obtain an interrupt frequency of 33.333kHz</span></div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    this-&gt;<a class="code" href="classuStepper.html#a44dea3569998b908a326fbe6509417e9">encoder</a>.<a class="code" href="classuStepperEncoder.html#a6d391ceaf50957f3d1ae8736a4c60d76">setup</a>();</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;}</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;</div>
<div class="line"><a name="l01242"></a><span class="lineno"><a class="line" href="classuStepper.html#aa3a08ba0871ec3fd1f0deba270d9bacf"> 1242</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#aa3a08ba0871ec3fd1f0deba270d9bacf">uStepper::startTimer</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;{</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    TCNT2 = 0;                          <span class="comment">//Clear counter value, to make sure we get correct timing</span></div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    TIFR2 |= (1 &lt;&lt; OCF2A);              <span class="comment">//Clear compare match interrupt flag, if it is set.</span></div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    TIMSK2 |= (1 &lt;&lt; OCIE2A);            <span class="comment">//Enable compare match interrupt</span></div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    sei();</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;}</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;</div>
<div class="line"><a name="l01251"></a><span class="lineno"><a class="line" href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4"> 1251</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4">uStepper::stopTimer</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;{</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    TIMSK2 &amp;= ~(1 &lt;&lt; OCF2A);            <span class="comment">//disable compare match interrupt</span></div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;}</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;</div>
<div class="line"><a name="l01256"></a><span class="lineno"><a class="line" href="classuStepper.html#addb2dd84de1d152201ee5320d5fe1308"> 1256</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#addb2dd84de1d152201ee5320d5fe1308">uStepper::enableMotor</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;{</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    PORTB &amp;= ~(1 &lt;&lt; 0);             <span class="comment">//Enable motor driver</span></div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;}</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;</div>
<div class="line"><a name="l01261"></a><span class="lineno"><a class="line" href="classuStepper.html#aba6edb2757fb57b204979a99fa0248d8"> 1261</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classuStepper.html#aba6edb2757fb57b204979a99fa0248d8">uStepper::disableMotor</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;{</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    PORTB |= (1 &lt;&lt; 0);          <span class="comment">//Disable motor driver</span></div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;}</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;</div>
<div class="line"><a name="l01266"></a><span class="lineno"><a class="line" href="classuStepper.html#a3df44604dec260335d84eded6aacfe91"> 1266</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classuStepper.html#a3df44604dec260335d84eded6aacfe91">uStepper::getCurrentDirection</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;{</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    <span class="keywordflow">return</span> this-&gt;<a class="code" href="classuStepper.html#aa734971bf8fee35c4a919ee080f020a7">direction</a>;</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;}</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;</div>
<div class="line"><a name="l01271"></a><span class="lineno"><a class="line" href="classuStepper.html#abf677a4d4dd2902c55295fdb4b91bd3f"> 1271</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classuStepper.html#abf677a4d4dd2902c55295fdb4b91bd3f">uStepper::getMotorState</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;{</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">state</a> != <a class="code" href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a>)</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;    {</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;        <span class="keywordflow">return</span> 1;       <span class="comment">//Motor running</span></div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    }</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    <span class="keywordflow">return</span> 0;           <span class="comment">//Motor not running</span></div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;}</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;</div>
<div class="line"><a name="l01281"></a><span class="lineno"><a class="line" href="classuStepper.html#aeb787bb58affb568cc583dd19fb7e5f8"> 1281</a></span>&#160;int64_t <a class="code" href="classuStepper.html#aeb787bb58affb568cc583dd19fb7e5f8">uStepper::getStepsSinceReset</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;{</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    <span class="keywordflow">if</span>(this-&gt;<a class="code" href="classuStepper.html#aa734971bf8fee35c4a919ee080f020a7">direction</a> == <a class="code" href="uStepper_8h.html#abe61b07c31c2a3e90576eb4c5d95b024">CW</a>)</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    {</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;        <span class="keywordflow">return</span> this-&gt;<a class="code" href="classuStepper.html#a98db94619cc110a32ea57f8cbbd97cb1">stepsSinceReset</a> + this-&gt;<a class="code" href="classuStepper.html#a1decfd6218df74c13ba70b55c47d3c2b">currentStep</a>;</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    }</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    {</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        <span class="keywordflow">return</span> this-&gt;<a class="code" href="classuStepper.html#a98db94619cc110a32ea57f8cbbd97cb1">stepsSinceReset</a> - this-&gt;<a class="code" href="classuStepper.html#a1decfd6218df74c13ba70b55c47d3c2b">currentStep</a>;</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    }</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;}</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;</div>
<div class="line"><a name="l01293"></a><span class="lineno"><a class="line" href="classi2cMaster.html#af74990f278bc2f34fed0bc25a17f31be"> 1293</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classi2cMaster.html#af74990f278bc2f34fed0bc25a17f31be">i2cMaster::cmd</a>(uint8_t cmd)</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;{</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    uint16_t i = 0;</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    <span class="comment">// send command</span></div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    TWCR = <a class="code" href="classi2cMaster.html#af74990f278bc2f34fed0bc25a17f31be">cmd</a>;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    <span class="comment">// wait for command to complete</span></div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    <span class="keywordflow">while</span> (!(TWCR &amp; (1 &lt;&lt; TWINT)));</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    </div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;    <span class="comment">// save status bits</span></div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;    <a class="code" href="classi2cMaster.html#a7a51e61bacd034eef996bc5ffccbb75b">status</a> = TWSR &amp; 0xF8;   </div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;}</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;</div>
<div class="line"><a name="l01305"></a><span class="lineno"><a class="line" href="classi2cMaster.html#a9d56b4ea47659456f19cff59ac96d5f9"> 1305</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classi2cMaster.html#a9d56b4ea47659456f19cff59ac96d5f9">i2cMaster::read</a>(uint8_t slaveAddr, uint8_t regAddr, uint8_t numOfBytes, uint8_t *data)</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;{</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;    uint8_t i, buff[numOfBytes];</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;    TIMSK1 &amp;= ~(1 &lt;&lt; OCIE1A);</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#a1f220aa9d4c43c6b6ff53395c76428af">start</a>(slaveAddr, <a class="code" href="uStepper_8h.html#aa10f470e996d0f51210d24f442d25e1e">WRITE</a>);</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#aff82a2330291c2940f41e8fd44f13cbf">writeByte</a>(regAddr);</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#a67daea3016661f33cdf8621d621300be">restart</a>(slaveAddr, <a class="code" href="uStepper_8h.html#ada74e7db007a68e763f20c17f2985356">READ</a>);</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;    <span class="keywordflow">for</span>(i = 0; i &lt; (numOfBytes - 1); i++)</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;    {</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        I2C.<a class="code" href="classi2cMaster.html#a631086e66e032c001da7ba7492ec4dc5">readByte</a>(<a class="code" href="uStepper_8h.html#a6f6489887e08bff4887d0bc5dcf214d8">ACK</a>, &amp;data[i]);</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;    }</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#a631086e66e032c001da7ba7492ec4dc5">readByte</a>(<a class="code" href="uStepper_8h.html#a958518a45b12053ae33606ee7cb68a55">NACK</a>, &amp;data[numOfBytes-1]);</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#aa3b88864e9b2b6a864c48721b34e206e">stop</a>();</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    TIMSK1 |= (1 &lt;&lt; OCIE1A);</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    </div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    <span class="keywordflow">return</span> 1; </div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;}</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;</div>
<div class="line"><a name="l01331"></a><span class="lineno"><a class="line" href="classi2cMaster.html#aebbb2715d84f89ea2d7b66d3d1ddc3e5"> 1331</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classi2cMaster.html#aebbb2715d84f89ea2d7b66d3d1ddc3e5">i2cMaster::write</a>(uint8_t slaveAddr, uint8_t regAddr, uint8_t numOfBytes, uint8_t *data)</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;{</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;    uint8_t i;</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;    TIMSK1 &amp;= ~(1 &lt;&lt; OCIE1A);</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#a1f220aa9d4c43c6b6ff53395c76428af">start</a>(slaveAddr, <a class="code" href="uStepper_8h.html#aa10f470e996d0f51210d24f442d25e1e">WRITE</a>);</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#aff82a2330291c2940f41e8fd44f13cbf">writeByte</a>(regAddr);</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    </div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    <span class="keywordflow">for</span>(i = 0; i &lt; numOfBytes; i++)</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    {</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;        I2C.<a class="code" href="classi2cMaster.html#aff82a2330291c2940f41e8fd44f13cbf">writeByte</a>(*(data + i));</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    }</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    I2C.<a class="code" href="classi2cMaster.html#aa3b88864e9b2b6a864c48721b34e206e">stop</a>();</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    TIMSK1 |= (1 &lt;&lt; OCIE1A);</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;}</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;</div>
<div class="line"><a name="l01351"></a><span class="lineno"><a class="line" href="classi2cMaster.html#a631086e66e032c001da7ba7492ec4dc5"> 1351</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classi2cMaster.html#a631086e66e032c001da7ba7492ec4dc5">i2cMaster::readByte</a>(<span class="keywordtype">bool</span> ack, uint8_t *data)</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;{</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;    <span class="keywordflow">if</span>(ack)</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    {</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;        this-&gt;<a class="code" href="classi2cMaster.html#af74990f278bc2f34fed0bc25a17f31be">cmd</a>((1 &lt;&lt; TWINT) | (1 &lt;&lt; TWEN) | (1 &lt;&lt; TWEA));</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    }</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;    </div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;    {</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        this-&gt;<a class="code" href="classi2cMaster.html#af74990f278bc2f34fed0bc25a17f31be">cmd</a>((1 &lt;&lt; TWINT) | (1 &lt;&lt; TWEN));</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    }</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;    *data = TWDR;</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;}</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;</div>
<div class="line"><a name="l01368"></a><span class="lineno"><a class="line" href="classi2cMaster.html#a1f220aa9d4c43c6b6ff53395c76428af"> 1368</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classi2cMaster.html#a1f220aa9d4c43c6b6ff53395c76428af">i2cMaster::start</a>(uint8_t addr, <span class="keywordtype">bool</span> RW)</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;{</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    <span class="comment">// send START condition</span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    this-&gt;<a class="code" href="classi2cMaster.html#af74990f278bc2f34fed0bc25a17f31be">cmd</a>((1&lt;&lt;TWINT) | (1&lt;&lt;TWSTA) | (1&lt;&lt;TWEN));</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    <span class="keywordflow">if</span> (this-&gt;<a class="code" href="classi2cMaster.html#a20091cd125f847e2cf50d0c7373adaa0">getStatus</a>() != <a class="code" href="uStepper_8h.html#a3018c7600b7bb9866400596a56a57af7">START</a> &amp;&amp; this-&gt;<a class="code" href="classi2cMaster.html#a20091cd125f847e2cf50d0c7373adaa0">getStatus</a>() != <a class="code" href="uStepper_8h.html#a819db82b3595334312089eb4340ef80d">REPSTART</a>) </div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    {</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;    }</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;    <span class="comment">// send device address and direction</span></div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    TWDR = (addr &lt;&lt; 1) | RW;</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    this-&gt;<a class="code" href="classi2cMaster.html#af74990f278bc2f34fed0bc25a17f31be">cmd</a>((1 &lt;&lt; TWINT) | (1 &lt;&lt; TWEN));</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    </div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    <span class="keywordflow">if</span> (RW == <a class="code" href="uStepper_8h.html#ada74e7db007a68e763f20c17f2985356">READ</a>) </div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    {</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;        <span class="keywordflow">return</span> this-&gt;<a class="code" href="classi2cMaster.html#a20091cd125f847e2cf50d0c7373adaa0">getStatus</a>() == <a class="code" href="uStepper_8h.html#a3c946fae086c9d624c8a65315fb9435a">RXADDRACK</a>;</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    } </div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <span class="keywordflow">else</span> </div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    {</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        <span class="keywordflow">return</span> this-&gt;<a class="code" href="classi2cMaster.html#a20091cd125f847e2cf50d0c7373adaa0">getStatus</a>() == <a class="code" href="uStepper_8h.html#a5c9e2ddf4b819e593cb8d9982dabb6dc">TXADDRACK</a>;</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    }</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;}</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;</div>
<div class="line"><a name="l01393"></a><span class="lineno"><a class="line" href="classi2cMaster.html#a67daea3016661f33cdf8621d621300be"> 1393</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classi2cMaster.html#a67daea3016661f33cdf8621d621300be">i2cMaster::restart</a>(uint8_t addr, <span class="keywordtype">bool</span> RW)</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;{</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    <span class="keywordflow">return</span> this-&gt;<a class="code" href="classi2cMaster.html#a1f220aa9d4c43c6b6ff53395c76428af">start</a>(addr, RW);</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;}</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;</div>
<div class="line"><a name="l01398"></a><span class="lineno"><a class="line" href="classi2cMaster.html#aff82a2330291c2940f41e8fd44f13cbf"> 1398</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classi2cMaster.html#aff82a2330291c2940f41e8fd44f13cbf">i2cMaster::writeByte</a>(uint8_t data)</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;{</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    TWDR = data;</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    this-&gt;<a class="code" href="classi2cMaster.html#af74990f278bc2f34fed0bc25a17f31be">cmd</a>((1 &lt;&lt; TWINT) | (1 &lt;&lt; TWEN));</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;    <span class="keywordflow">return</span> this-&gt;<a class="code" href="classi2cMaster.html#a20091cd125f847e2cf50d0c7373adaa0">getStatus</a>() == <a class="code" href="uStepper_8h.html#a78fba4172fe66a2c2a1e6badf418da9c">TXDATAACK</a>;</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;}</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;</div>
<div class="line"><a name="l01407"></a><span class="lineno"><a class="line" href="classi2cMaster.html#aa3b88864e9b2b6a864c48721b34e206e"> 1407</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classi2cMaster.html#aa3b88864e9b2b6a864c48721b34e206e">i2cMaster::stop</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;{</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    uint16_t i = 0;</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    <span class="comment">//  issue stop condition</span></div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;    TWCR = (1 &lt;&lt; TWINT) | (1 &lt;&lt; TWEN) | (1 &lt;&lt; TWSTO);</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    <span class="comment">// wait until stop condition is executed and bus released</span></div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    <span class="keywordflow">while</span> (TWCR &amp; (1 &lt;&lt; TWSTO));</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    <a class="code" href="classi2cMaster.html#a7a51e61bacd034eef996bc5ffccbb75b">status</a> = <a class="code" href="uStepper_8h.html#a46fd28b671402790a8b9c4c2dde700d8">I2CFREE</a>;</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;}</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;</div>
<div class="line"><a name="l01421"></a><span class="lineno"><a class="line" href="classi2cMaster.html#a20091cd125f847e2cf50d0c7373adaa0"> 1421</a></span>&#160;uint8_t <a class="code" href="classi2cMaster.html#a20091cd125f847e2cf50d0c7373adaa0">i2cMaster::getStatus</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;{</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classi2cMaster.html#a7a51e61bacd034eef996bc5ffccbb75b">status</a>;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;}</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;</div>
<div class="line"><a name="l01426"></a><span class="lineno"><a class="line" href="classi2cMaster.html#af639b1fb501c7530afdca5e87a56168f"> 1426</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classi2cMaster.html#af639b1fb501c7530afdca5e87a56168f">i2cMaster::begin</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;{</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    <span class="comment">// set bit rate register to 12 to obtain 400kHz scl frequency (in combination with no prescaling!)</span></div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;    TWBR = 12;</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    <span class="comment">// no prescaler</span></div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    TWSR &amp;= 0xFC;</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;}</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;</div>
<div class="line"><a name="l01434"></a><span class="lineno"><a class="line" href="classi2cMaster.html#a2d4c2077400ec94c157916804e9fdaae"> 1434</a></span>&#160;<a class="code" href="classi2cMaster.html#a2d4c2077400ec94c157916804e9fdaae">i2cMaster::i2cMaster</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;{</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;}</div>
<div class="ttc" id="uStepper_8h_html_a5c71a5e59a53413cd6c270266d63b031"><div class="ttname"><a href="uStepper_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a></div><div class="ttdeci">#define R</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00192">uStepper.h:192</a></div></div>
<div class="ttc" id="classuStepper_html_a554b67202deeb611116ba62383ecb783"><div class="ttname"><a href="classuStepper.html#a554b67202deeb611116ba62383ecb783">uStepper::uStepper</a></div><div class="ttdeci">uStepper(void)</div><div class="ttdoc">Constructor of uStepper class. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00781">uStepper.cpp:781</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_ab9c80a99fca938eeb490e4ed8d109f04"><div class="ttname"><a href="classuStepperEncoder.html#ab9c80a99fca938eeb490e4ed8d109f04">uStepperEncoder::uStepperEncoder</a></div><div class="ttdeci">uStepperEncoder(void)</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00652">uStepper.cpp:652</a></div></div>
<div class="ttc" id="classuStepper_html_a972acc9f6df3cbea8909f1ce7d3fa3d2"><div class="ttname"><a href="classuStepper.html#a972acc9f6df3cbea8909f1ce7d3fa3d2">uStepper::setup</a></div><div class="ttdeci">void setup(bool mode=NORMAL, uint8_t microStepping=SIXTEEN, float faultSpeed=3000.0, uint32_t faultTolerance=20)</div><div class="ttdoc">Initializes the different parts of the uStepper object. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01216">uStepper.cpp:1216</a></div></div>
<div class="ttc" id="classuStepper_html_a1decfd6218df74c13ba70b55c47d3c2b"><div class="ttname"><a href="classuStepper.html#a1decfd6218df74c13ba70b55c47d3c2b">uStepper::currentStep</a></div><div class="ttdeci">uint32_t currentStep</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00452">uStepper.h:452</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_a26b81725b7a995fed98de0fcdd614b1f"><div class="ttname"><a href="classuStepperEncoder.html#a26b81725b7a995fed98de0fcdd614b1f">uStepperEncoder::getStrength</a></div><div class="ttdeci">uint16_t getStrength(void)</div><div class="ttdoc">Measure the strength of the magnet. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00737">uStepper.cpp:737</a></div></div>
<div class="ttc" id="uStepper_8h_html_afe63280e8006a836668a21fa62ed7630"><div class="ttname"><a href="uStepper_8h.html#afe63280e8006a836668a21fa62ed7630">CRUISE</a></div><div class="ttdeci">#define CRUISE</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00173">uStepper.h:173</a></div></div>
<div class="ttc" id="uStepper_8h_html_aa10f470e996d0f51210d24f442d25e1e"><div class="ttname"><a href="uStepper_8h.html#aa10f470e996d0f51210d24f442d25e1e">WRITE</a></div><div class="ttdeci">#define WRITE</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00198">uStepper.h:198</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_a8812beadc9bec6f4e321d281d9b6ea79"><div class="ttname"><a href="classuStepperEncoder.html#a8812beadc9bec6f4e321d281d9b6ea79">uStepperEncoder::getSpeed</a></div><div class="ttdeci">float getSpeed(void)</div><div class="ttdoc">Measure the current speed of the motor. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00695">uStepper.cpp:695</a></div></div>
<div class="ttc" id="classi2cMaster_html_aebbb2715d84f89ea2d7b66d3d1ddc3e5"><div class="ttname"><a href="classi2cMaster.html#aebbb2715d84f89ea2d7b66d3d1ddc3e5">i2cMaster::write</a></div><div class="ttdeci">bool write(uint8_t slaveAddr, uint8_t regAddr, uint8_t numOfBytes, uint8_t *data)</div><div class="ttdoc">sets up I2C connection to device, writes a number of data bytes and closes the connection ...</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01331">uStepper.cpp:1331</a></div></div>
<div class="ttc" id="classuStepper_html_abf677a4d4dd2902c55295fdb4b91bd3f"><div class="ttname"><a href="classuStepper.html#abf677a4d4dd2902c55295fdb4b91bd3f">uStepper::getMotorState</a></div><div class="ttdeci">bool getMotorState(void)</div><div class="ttdoc">Get the current state of the motor. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01271">uStepper.cpp:1271</a></div></div>
<div class="ttc" id="classuStepper_html_a7d69fe56b00bbdc535901d96c1504fff"><div class="ttname"><a href="classuStepper.html#a7d69fe56b00bbdc535901d96c1504fff">uStepper::multiplier</a></div><div class="ttdeci">float2 multiplier</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00440">uStepper.h:440</a></div></div>
<div class="ttc" id="classuStepper_html_ae238f130c9ad5ab60743d4fe9847da97"><div class="ttname"><a href="classuStepper.html#ae238f130c9ad5ab60743d4fe9847da97">uStepper::acceleration</a></div><div class="ttdeci">float acceleration</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00472">uStepper.h:472</a></div></div>
<div class="ttc" id="classuStepper_html_a3f2726a90ba7379b1d079d7d86368f5b"><div class="ttname"><a href="classuStepper.html#a3f2726a90ba7379b1d079d7d86368f5b">uStepper::continous</a></div><div class="ttdeci">bool continous</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00456">uStepper.h:456</a></div></div>
<div class="ttc" id="classuStepper_html"><div class="ttname"><a href="classuStepper.html">uStepper</a></div><div class="ttdoc">Prototype of class for accessing all features of the uStepper in a single object. ...</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00434">uStepper.h:434</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_afe0647659291c6ed4f4104e95f5ae047"><div class="ttname"><a href="classuStepperEncoder.html#afe0647659291c6ed4f4104e95f5ae047">uStepperEncoder::curSpeed</a></div><div class="ttdeci">volatile float curSpeed</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00423">uStepper.h:423</a></div></div>
<div class="ttc" id="classuStepper_html_addb2dd84de1d152201ee5320d5fe1308"><div class="ttname"><a href="classuStepper.html#addb2dd84de1d152201ee5320d5fe1308">uStepper::enableMotor</a></div><div class="ttdeci">void enableMotor(void)</div><div class="ttdoc">Enables the stepper driver output stage. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01256">uStepper.cpp:1256</a></div></div>
<div class="ttc" id="uStepper_8h_html_a955f504eccf76b4eb2489c0adab03121"><div class="ttname"><a href="uStepper_8h.html#a955f504eccf76b4eb2489c0adab03121">A</a></div><div class="ttdeci">#define A</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00230">uStepper.h:230</a></div></div>
<div class="ttc" id="classuStepper_html_a352e4b96324adfe1feb66ab4f88c3745"><div class="ttname"><a href="classuStepper.html#a352e4b96324adfe1feb66ab4f88c3745">uStepper::getMaxAcceleration</a></div><div class="ttdeci">float getMaxAcceleration(void)</div><div class="ttdoc">Get the value of the maximum motor acceleration. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00830">uStepper.cpp:830</a></div></div>
<div class="ttc" id="uStepper_8h_html_abe61b07c31c2a3e90576eb4c5d95b024"><div class="ttname"><a href="uStepper_8h.html#abe61b07c31c2a3e90576eb4c5d95b024">CW</a></div><div class="ttdeci">#define CW</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00177">uStepper.h:177</a></div></div>
<div class="ttc" id="uStepper_8h_html_a8e111344ca6ef978238061294b46c5f9"><div class="ttname"><a href="uStepper_8h.html#a8e111344ca6ef978238061294b46c5f9">DECEL</a></div><div class="ttdeci">#define DECEL</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00174">uStepper.h:174</a></div></div>
<div class="ttc" id="classuStepperTemp_html_a9ddadd3aadbd94e0f0290ebccf05ae2d"><div class="ttname"><a href="classuStepperTemp.html#a9ddadd3aadbd94e0f0290ebccf05ae2d">uStepperTemp::getTemp</a></div><div class="ttdeci">float getTemp(void)</div><div class="ttdoc">Request a reading of current temperature. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00637">uStepper.cpp:637</a></div></div>
<div class="ttc" id="uStepper_8h_html_a3c946fae086c9d624c8a65315fb9435a"><div class="ttname"><a href="uStepper_8h.html#a3c946fae086c9d624c8a65315fb9435a">RXADDRACK</a></div><div class="ttdeci">#define RXADDRACK</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00208">uStepper.h:208</a></div></div>
<div class="ttc" id="classuStepper_html_acd0a3486401356e9d0639fcfce520374"><div class="ttname"><a href="classuStepper.html#acd0a3486401356e9d0639fcfce520374">uStepper::cruiseSteps</a></div><div class="ttdeci">uint32_t cruiseSteps</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00450">uStepper.h:450</a></div></div>
<div class="ttc" id="classuStepper_html_a26d4b8c24afb5aaba77daa0d3a95225b"><div class="ttname"><a href="classuStepper.html#a26d4b8c24afb5aaba77daa0d3a95225b">uStepper::totalSteps</a></div><div class="ttdeci">uint32_t totalSteps</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00454">uStepper.h:454</a></div></div>
<div class="ttc" id="uStepper_8h_html_ac4cf4b2ab929bd23951a8676eeac086b"><div class="ttname"><a href="uStepper_8h.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a></div><div class="ttdeci">#define C</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00232">uStepper.h:232</a></div></div>
<div class="ttc" id="classuStepper_html_a3df44604dec260335d84eded6aacfe91"><div class="ttname"><a href="classuStepper.html#a3df44604dec260335d84eded6aacfe91">uStepper::getCurrentDirection</a></div><div class="ttdeci">bool getCurrentDirection(void)</div><div class="ttdoc">Returns the direction the motor is currently configured to rotate. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01266">uStepper.cpp:1266</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_a29117f4952ff99ba53b90b842f4e69f1"><div class="ttname"><a href="classuStepperEncoder.html#a29117f4952ff99ba53b90b842f4e69f1">uStepperEncoder::getAngleMoved</a></div><div class="ttdeci">float getAngleMoved(void)</div><div class="ttdoc">Measure the angle moved from reference position. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00657">uStepper.cpp:657</a></div></div>
<div class="ttc" id="classuStepper_html_a5c780ca98e925402711a3810ba873649"><div class="ttname"><a href="classuStepper.html#a5c780ca98e925402711a3810ba873649">uStepper::accelSteps</a></div><div class="ttdeci">uint32_t accelSteps</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00444">uStepper.h:444</a></div></div>
<div class="ttc" id="uStepper_8h_html_a2e619f47c3bc5b6af8ea904dbf5c98fe"><div class="ttname"><a href="uStepper_8h.html#a2e619f47c3bc5b6af8ea904dbf5c98fe">ENCODERADDR</a></div><div class="ttdeci">#define ENCODERADDR</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00182">uStepper.h:182</a></div></div>
<div class="ttc" id="classuStepper_html_a03884a4ae4613bd574d1d87e6658a5e8"><div class="ttname"><a href="classuStepper.html#a03884a4ae4613bd574d1d87e6658a5e8">uStepper::hardStop</a></div><div class="ttdeci">void hardStop(bool holdMode)</div><div class="ttdoc">Stop the motor without deceleration. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01137">uStepper.cpp:1137</a></div></div>
<div class="ttc" id="classuStepper_html_a97998e6f4b3f6eac8226d4670548edf0"><div class="ttname"><a href="classuStepper.html#a97998e6f4b3f6eac8226d4670548edf0">uStepper::setMaxAcceleration</a></div><div class="ttdeci">void setMaxAcceleration(float accel)</div><div class="ttdoc">Set the maximum acceleration of the stepper motor. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00810">uStepper.cpp:810</a></div></div>
<div class="ttc" id="classuStepper_html_aa3a08ba0871ec3fd1f0deba270d9bacf"><div class="ttname"><a href="classuStepper.html#aa3a08ba0871ec3fd1f0deba270d9bacf">uStepper::startTimer</a></div><div class="ttdeci">void startTimer(void)</div><div class="ttdoc">Starts timer for stepper algorithm. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01242">uStepper.cpp:1242</a></div></div>
<div class="ttc" id="classuStepper_html_a3058a91bbd7ee379127b8ff354d8cdff"><div class="ttname"><a href="classuStepper.html#a3058a91bbd7ee379127b8ff354d8cdff">uStepper::setMaxVelocity</a></div><div class="ttdeci">void setMaxVelocity(float vel)</div><div class="ttdoc">Sets the maximum rotational velocity of the motor. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00860">uStepper.cpp:860</a></div></div>
<div class="ttc" id="classuStepper_html_a1fdc8d8673b58ac5dbd23652128d55c0"><div class="ttname"><a href="classuStepper.html#a1fdc8d8673b58ac5dbd23652128d55c0">uStepper::moveSteps</a></div><div class="ttdeci">void moveSteps(uint32_t steps, bool dir, bool holdMode)</div><div class="ttdoc">Make the motor perform a predefined number of steps. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00984">uStepper.cpp:984</a></div></div>
<div class="ttc" id="uStepper_8h_html_ae19b6bb2940d2fbe0a79852b070eeafd"><div class="ttname"><a href="uStepper_8h.html#ae19b6bb2940d2fbe0a79852b070eeafd">STOP</a></div><div class="ttdeci">#define STOP</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00171">uStepper.h:171</a></div></div>
<div class="ttc" id="classuStepper_html_a1e88bdd345aba07f23409df7d7f93a89"><div class="ttname"><a href="classuStepper.html#a1e88bdd345aba07f23409df7d7f93a89">uStepper::getMaxVelocity</a></div><div class="ttdeci">float getMaxVelocity(void)</div><div class="ttdoc">Returns the maximum rotational velocity of the motor. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00893">uStepper.cpp:893</a></div></div>
<div class="ttc" id="classi2cMaster_html_aff82a2330291c2940f41e8fd44f13cbf"><div class="ttname"><a href="classi2cMaster.html#aff82a2330291c2940f41e8fd44f13cbf">i2cMaster::writeByte</a></div><div class="ttdeci">bool writeByte(uint8_t data)</div><div class="ttdoc">Writes a byte to a device on the I2C bus. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01398">uStepper.cpp:1398</a></div></div>
<div class="ttc" id="classi2cMaster_html_a2d4c2077400ec94c157916804e9fdaae"><div class="ttname"><a href="classi2cMaster.html#a2d4c2077400ec94c157916804e9fdaae">i2cMaster::i2cMaster</a></div><div class="ttdeci">i2cMaster(void)</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01434">uStepper.cpp:1434</a></div></div>
<div class="ttc" id="classuStepper_html_af5715f56bed814257f496150e032b41c"><div class="ttname"><a href="classuStepper.html#af5715f56bed814257f496150e032b41c">uStepper::softStop</a></div><div class="ttdeci">void softStop(bool holdMode)</div><div class="ttdoc">Stop the motor with deceleration. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01168">uStepper.cpp:1168</a></div></div>
<div class="ttc" id="classi2cMaster_html_a7a51e61bacd034eef996bc5ffccbb75b"><div class="ttname"><a href="classi2cMaster.html#a7a51e61bacd034eef996bc5ffccbb75b">i2cMaster::status</a></div><div class="ttdeci">uint8_t status</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00719">uStepper.h:719</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_a990203acc3069947412e0a9dd36bc988"><div class="ttname"><a href="classuStepperEncoder.html#a990203acc3069947412e0a9dd36bc988">uStepperEncoder::detectMagnet</a></div><div class="ttdeci">uint8_t detectMagnet(void)</div><div class="ttdoc">Detect if magnet is present and within range. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00755">uStepper.cpp:755</a></div></div>
<div class="ttc" id="classfloat2_html"><div class="ttname"><a href="classfloat2.html">float2</a></div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00243">uStepper.h:243</a></div></div>
<div class="ttc" id="classi2cMaster_html_a20091cd125f847e2cf50d0c7373adaa0"><div class="ttname"><a href="classi2cMaster.html#a20091cd125f847e2cf50d0c7373adaa0">i2cMaster::getStatus</a></div><div class="ttdeci">uint8_t getStatus(void)</div><div class="ttdoc">Get current I2C status. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01421">uStepper.cpp:1421</a></div></div>
<div class="ttc" id="uStepper_8h_html_ada74e7db007a68e763f20c17f2985356"><div class="ttname"><a href="uStepper_8h.html#ada74e7db007a68e763f20c17f2985356">READ</a></div><div class="ttdeci">#define READ</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00196">uStepper.h:196</a></div></div>
<div class="ttc" id="classi2cMaster_html_af74990f278bc2f34fed0bc25a17f31be"><div class="ttname"><a href="classi2cMaster.html#af74990f278bc2f34fed0bc25a17f31be">i2cMaster::cmd</a></div><div class="ttdeci">void cmd(uint8_t cmd)</div><div class="ttdoc">Sends commands over the I2C bus. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01293">uStepper.cpp:1293</a></div></div>
<div class="ttc" id="classi2cMaster_html_a67daea3016661f33cdf8621d621300be"><div class="ttname"><a href="classi2cMaster.html#a67daea3016661f33cdf8621d621300be">i2cMaster::restart</a></div><div class="ttdeci">bool restart(uint8_t addr, bool RW)</div><div class="ttdoc">Restarts connection between arduino and I2C device. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01393">uStepper.cpp:1393</a></div></div>
<div class="ttc" id="classi2cMaster_html_a631086e66e032c001da7ba7492ec4dc5"><div class="ttname"><a href="classi2cMaster.html#a631086e66e032c001da7ba7492ec4dc5">i2cMaster::readByte</a></div><div class="ttdeci">bool readByte(bool ack, uint8_t *data)</div><div class="ttdoc">Reads a byte from the I2C bus. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01351">uStepper.cpp:1351</a></div></div>
<div class="ttc" id="classuStepper_html_a98db94619cc110a32ea57f8cbbd97cb1"><div class="ttname"><a href="classuStepper.html#a98db94619cc110a32ea57f8cbbd97cb1">uStepper::stepsSinceReset</a></div><div class="ttdeci">int64_t stepsSinceReset</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00462">uStepper.h:462</a></div></div>
<div class="ttc" id="classuStepper_html_a44dea3569998b908a326fbe6509417e9"><div class="ttname"><a href="classuStepper.html#a44dea3569998b908a326fbe6509417e9">uStepper::encoder</a></div><div class="ttdeci">uStepperEncoder encoder</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00522">uStepper.h:522</a></div></div>
<div class="ttc" id="uStepper_8h_html_a4d14a79c82f3f831303e38487811eda4"><div class="ttname"><a href="uStepper_8h.html#a4d14a79c82f3f831303e38487811eda4">HARD</a></div><div class="ttdeci">#define HARD</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00179">uStepper.h:179</a></div></div>
<div class="ttc" id="classuStepper_html_a8e795410f167d9473ea871ee31f9e5f4"><div class="ttname"><a href="classuStepper.html#a8e795410f167d9473ea871ee31f9e5f4">uStepper::stopTimer</a></div><div class="ttdeci">void stopTimer(void)</div><div class="ttdoc">Stops the timer for the stepper algorithm. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01251">uStepper.cpp:1251</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_a8a4a9e8dab1412c67de52b4454050d3e"><div class="ttname"><a href="classuStepperEncoder.html#a8a4a9e8dab1412c67de52b4454050d3e">uStepperEncoder::getAgc</a></div><div class="ttdeci">uint8_t getAgc(void)</div><div class="ttdoc">Read the current AGC value of the encoder chip. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00746">uStepper.cpp:746</a></div></div>
<div class="ttc" id="classi2cMaster_html_a1f220aa9d4c43c6b6ff53395c76428af"><div class="ttname"><a href="classi2cMaster.html#a1f220aa9d4c43c6b6ff53395c76428af">i2cMaster::start</a></div><div class="ttdeci">bool start(uint8_t addr, bool RW)</div><div class="ttdoc">sets up connection between arduino and I2C device. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01368">uStepper.cpp:1368</a></div></div>
<div class="ttc" id="uStepper_8h_html_acaa6e10cd07d7a2e7fda09e5f0821858"><div class="ttname"><a href="uStepper_8h.html#acaa6e10cd07d7a2e7fda09e5f0821858">MAGNITUDE</a></div><div class="ttdeci">#define MAGNITUDE</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00187">uStepper.h:187</a></div></div>
<div class="ttc" id="classuStepper_html_a963e4d53e856238e5a4f54be38b8a8b3"><div class="ttname"><a href="classuStepper.html#a963e4d53e856238e5a4f54be38b8a8b3">uStepper::runContinous</a></div><div class="ttdeci">void runContinous(bool dir)</div><div class="ttdoc">Make the motor rotate continuously. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00898">uStepper.cpp:898</a></div></div>
<div class="ttc" id="uStepper_8h_html_a2d6d8ed93a3b37e34993ff25b5dfa6f3"><div class="ttname"><a href="uStepper_8h.html#a2d6d8ed93a3b37e34993ff25b5dfa6f3">INTFREQ</a></div><div class="ttdeci">#define INTFREQ</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00176">uStepper.h:176</a></div></div>
<div class="ttc" id="uStepper_8h_html_a1dcbcf84029ec88eb045567b083355c8"><div class="ttname"><a href="uStepper_8h.html#a1dcbcf84029ec88eb045567b083355c8">ENCODERSPEEDCONSTANT</a></div><div class="ttdeci">#define ENCODERSPEEDCONSTANT</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00190">uStepper.h:190</a></div></div>
<div class="ttc" id="classi2cMaster_html"><div class="ttname"><a href="classi2cMaster.html">i2cMaster</a></div><div class="ttdoc">Prototype of class for accessing the TWI (I2C) interface of the AVR (master mode only). </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00716">uStepper.h:716</a></div></div>
<div class="ttc" id="uStepper_8h_html_a8a7f485573c16394fc0792a66bd02c7a"><div class="ttname"><a href="uStepper_8h.html#a8a7f485573c16394fc0792a66bd02c7a">ANGLE</a></div><div class="ttdeci">#define ANGLE</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00184">uStepper.h:184</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_abf3fc82540c092e8a6c68d4580bedbf9"><div class="ttname"><a href="classuStepperEncoder.html#abf3fc82540c092e8a6c68d4580bedbf9">uStepperEncoder::setHome</a></div><div class="ttdeci">void setHome(void)</div><div class="ttdoc">Define new reference(home) position. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00719">uStepper.cpp:719</a></div></div>
<div class="ttc" id="uStepper_8h_html_a1b44ecf82561bec987fa3c07632335a4"><div class="ttname"><a href="uStepper_8h.html#a1b44ecf82561bec987fa3c07632335a4">SOFT</a></div><div class="ttdeci">#define SOFT</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00180">uStepper.h:180</a></div></div>
<div class="ttc" id="classuStepper_html_aecedcc41a09006be3d2f671c6732b615"><div class="ttname"><a href="classuStepper.html#aecedcc41a09006be3d2f671c6732b615">uStepper::cruiseDelay</a></div><div class="ttdeci">uint16_t cruiseDelay</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00438">uStepper.h:438</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_abf760d7949e75977bf11bce48256283c"><div class="ttname"><a href="classuStepperEncoder.html#abf760d7949e75977bf11bce48256283c">uStepperEncoder::getAngle</a></div><div class="ttdeci">float getAngle(void)</div><div class="ttdoc">Measure the current shaft angle. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00732">uStepper.cpp:732</a></div></div>
<div class="ttc" id="uStepper_8h_html_a6f6489887e08bff4887d0bc5dcf214d8"><div class="ttname"><a href="uStepper_8h.html#a6f6489887e08bff4887d0bc5dcf214d8">ACK</a></div><div class="ttdeci">#define ACK</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00210">uStepper.h:210</a></div></div>
<div class="ttc" id="uStepper_8h_html_a111da81ae5883147168bbb8366377b10"><div class="ttname"><a href="uStepper_8h.html#a111da81ae5883147168bbb8366377b10">B</a></div><div class="ttdeci">#define B</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00231">uStepper.h:231</a></div></div>
<div class="ttc" id="classi2cMaster_html_aa3b88864e9b2b6a864c48721b34e206e"><div class="ttname"><a href="classi2cMaster.html#aa3b88864e9b2b6a864c48721b34e206e">i2cMaster::stop</a></div><div class="ttdeci">bool stop(void)</div><div class="ttdoc">Closes the I2C connection. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01407">uStepper.cpp:1407</a></div></div>
<div class="ttc" id="uStepper_8h_html_a6b14c0a97e1a526bf898cd24de183afb"><div class="ttname"><a href="uStepper_8h.html#a6b14c0a97e1a526bf898cd24de183afb">AGC</a></div><div class="ttdeci">#define AGC</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00186">uStepper.h:186</a></div></div>
<div class="ttc" id="uStepper_8cpp_html_a3216dd3022dcb4a4e82d44fd41509e8e"><div class="ttname"><a href="uStepper_8cpp.html#a3216dd3022dcb4a4e82d44fd41509e8e">I2C</a></div><div class="ttdeci">i2cMaster I2C</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00073">uStepper.cpp:73</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_a372f52c9553676ebb2ea08f6624f3042"><div class="ttname"><a href="classuStepperEncoder.html#a372f52c9553676ebb2ea08f6624f3042">uStepperEncoder::oldAngle</a></div><div class="ttdeci">volatile float oldAngle</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00421">uStepper.h:421</a></div></div>
<div class="ttc" id="uStepper_8h_html_a46fd28b671402790a8b9c4c2dde700d8"><div class="ttname"><a href="uStepper_8h.html#a46fd28b671402790a8b9c4c2dde700d8">I2CFREE</a></div><div class="ttdeci">#define I2CFREE</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00194">uStepper.h:194</a></div></div>
<div class="ttc" id="uStepper_8h_html_a819db82b3595334312089eb4340ef80d"><div class="ttname"><a href="uStepper_8h.html#a819db82b3595334312089eb4340ef80d">REPSTART</a></div><div class="ttdeci">#define REPSTART</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00202">uStepper.h:202</a></div></div>
<div class="ttc" id="classi2cMaster_html_af639b1fb501c7530afdca5e87a56168f"><div class="ttname"><a href="classi2cMaster.html#af639b1fb501c7530afdca5e87a56168f">i2cMaster::begin</a></div><div class="ttdeci">void begin(void)</div><div class="ttdoc">Setup TWI (I2C) interface. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01426">uStepper.cpp:1426</a></div></div>
<div class="ttc" id="uStepper_8h_html_a78fba4172fe66a2c2a1e6badf418da9c"><div class="ttname"><a href="uStepper_8h.html#a78fba4172fe66a2c2a1e6badf418da9c">TXDATAACK</a></div><div class="ttdeci">#define TXDATAACK</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00206">uStepper.h:206</a></div></div>
<div class="ttc" id="uStepper_8h_html_a958518a45b12053ae33606ee7cb68a55"><div class="ttname"><a href="uStepper_8h.html#a958518a45b12053ae33606ee7cb68a55">NACK</a></div><div class="ttdeci">#define NACK</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00212">uStepper.h:212</a></div></div>
<div class="ttc" id="uStepper_8h_html"><div class="ttname"><a href="uStepper_8h.html">uStepper.h</a></div><div class="ttdoc">Function prototypes and definitions for the uStepper library. </div></div>
<div class="ttc" id="uStepper_8h_html_ad2d7243c099b33b2343976dd3ee8b36b"><div class="ttname"><a href="uStepper_8h.html#ad2d7243c099b33b2343976dd3ee8b36b">ACCEL</a></div><div class="ttdeci">#define ACCEL</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00172">uStepper.h:172</a></div></div>
<div class="ttc" id="uStepper_8h_html_a0c1151fb74132a2a24a1483ca529d511"><div class="ttname"><a href="uStepper_8h.html#a0c1151fb74132a2a24a1483ca529d511">INITDECEL</a></div><div class="ttdeci">#define INITDECEL</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00175">uStepper.h:175</a></div></div>
<div class="ttc" id="classuStepper_html_a67ab99136fae0691ed3ab8c9a677e8a5"><div class="ttname"><a href="classuStepper.html#a67ab99136fae0691ed3ab8c9a677e8a5">uStepper::velocity</a></div><div class="ttdeci">float velocity</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00470">uStepper.h:470</a></div></div>
<div class="ttc" id="classuStepper_html_acada6650a93fddb4ad5b2b802adad7cf"><div class="ttname"><a href="classuStepper.html#acada6650a93fddb4ad5b2b802adad7cf">uStepper::exactDelay</a></div><div class="ttdeci">float2 exactDelay</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00464">uStepper.h:464</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_a5185708424b99dd13bbe6d9f0ad4f603"><div class="ttname"><a href="classuStepperEncoder.html#a5185708424b99dd13bbe6d9f0ad4f603">uStepperEncoder::angleMoved</a></div><div class="ttdeci">volatile float angleMoved</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00424">uStepper.h:424</a></div></div>
<div class="ttc" id="classuStepper_html_af406f7f37fadc3ababf95e3bbebb302f"><div class="ttname"><a href="classuStepper.html#af406f7f37fadc3ababf95e3bbebb302f">uStepper::state</a></div><div class="ttdeci">uint8_t state</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00442">uStepper.h:442</a></div></div>
<div class="ttc" id="classuStepperTemp_html_ae22b3413a9c687e8832b62dd06d0e943"><div class="ttname"><a href="classuStepperTemp.html#ae22b3413a9c687e8832b62dd06d0e943">uStepperTemp::uStepperTemp</a></div><div class="ttdeci">uStepperTemp(void)</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00632">uStepper.cpp:632</a></div></div>
<div class="ttc" id="classuStepper_html_ade7b941e918d02f6dd4f8e0fbaf603a5"><div class="ttname"><a href="classuStepper.html#ade7b941e918d02f6dd4f8e0fbaf603a5">uStepper::delay</a></div><div class="ttdeci">uint16_t delay</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00466">uStepper.h:466</a></div></div>
<div class="ttc" id="classi2cMaster_html_a9d56b4ea47659456f19cff59ac96d5f9"><div class="ttname"><a href="classi2cMaster.html#a9d56b4ea47659456f19cff59ac96d5f9">i2cMaster::read</a></div><div class="ttdeci">bool read(uint8_t slaveAddr, uint8_t regAddr, uint8_t numOfBytes, uint8_t *data)</div><div class="ttdoc">sets up I2C connection to device, reads a number of data bytes and closes the connection ...</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01305">uStepper.cpp:1305</a></div></div>
<div class="ttc" id="classuStepper_html_a79bfb3a786d706a510852d85f7172552"><div class="ttname"><a href="classuStepper.html#a79bfb3a786d706a510852d85f7172552">uStepper::decelSteps</a></div><div class="ttdeci">uint32_t decelSteps</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00446">uStepper.h:446</a></div></div>
<div class="ttc" id="classuStepper_html_aa734971bf8fee35c4a919ee080f020a7"><div class="ttname"><a href="classuStepper.html#aa734971bf8fee35c4a919ee080f020a7">uStepper::direction</a></div><div class="ttdeci">bool direction</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00460">uStepper.h:460</a></div></div>
<div class="ttc" id="classuStepper_html_a4099233d63e894e8a8e364da8334c129"><div class="ttname"><a href="classuStepper.html#a4099233d63e894e8a8e364da8334c129">uStepper::hold</a></div><div class="ttdeci">bool hold</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00458">uStepper.h:458</a></div></div>
<div class="ttc" id="uStepper_8h_html_a3018c7600b7bb9866400596a56a57af7"><div class="ttname"><a href="uStepper_8h.html#a3018c7600b7bb9866400596a56a57af7">START</a></div><div class="ttdeci">#define START</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00200">uStepper.h:200</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_a732a1d71de7978312f24a70b8c1301a4"><div class="ttname"><a href="classuStepperEncoder.html#a732a1d71de7978312f24a70b8c1301a4">uStepperEncoder::encoderOffset</a></div><div class="ttdeci">float encoderOffset</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00420">uStepper.h:420</a></div></div>
<div class="ttc" id="classuStepper_html_aba6edb2757fb57b204979a99fa0248d8"><div class="ttname"><a href="classuStepper.html#aba6edb2757fb57b204979a99fa0248d8">uStepper::disableMotor</a></div><div class="ttdeci">void disableMotor(void)</div><div class="ttdoc">Disables the stepper driver output stage. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01261">uStepper.cpp:1261</a></div></div>
<div class="ttc" id="uStepper_8h_html_a5c9e2ddf4b819e593cb8d9982dabb6dc"><div class="ttname"><a href="uStepper_8h.html#a5c9e2ddf4b819e593cb8d9982dabb6dc">TXADDRACK</a></div><div class="ttdeci">#define TXADDRACK</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00204">uStepper.h:204</a></div></div>
<div class="ttc" id="classuStepper_html_aeb787bb58affb568cc583dd19fb7e5f8"><div class="ttname"><a href="classuStepper.html#aeb787bb58affb568cc583dd19fb7e5f8">uStepper::getStepsSinceReset</a></div><div class="ttdeci">int64_t getStepsSinceReset(void)</div><div class="ttdoc">Get the number of steps applied since reset. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l01281">uStepper.cpp:1281</a></div></div>
<div class="ttc" id="classuStepperEncoder_html_a6d391ceaf50957f3d1ae8736a4c60d76"><div class="ttname"><a href="classuStepperEncoder.html#a6d391ceaf50957f3d1ae8736a4c60d76">uStepperEncoder::setup</a></div><div class="ttdeci">void setup(void)</div><div class="ttdoc">Setup the encoder. </div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8cpp_source.html#l00700">uStepper.cpp:700</a></div></div>
<div class="ttc" id="classuStepper_html_ac8e3d3157ea9b11dec50354396e67ef6"><div class="ttname"><a href="classuStepper.html#ac8e3d3157ea9b11dec50354396e67ef6">uStepper::initialDecelSteps</a></div><div class="ttdeci">uint32_t initialDecelSteps</div><div class="ttdef"><b>Definition:</b> <a href="uStepper_8h_source.html#l00448">uStepper.h:448</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 3 2016 16:33:34 for uStepper by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
